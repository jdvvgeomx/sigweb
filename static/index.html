<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Mapa Interactivo</title>
    <!-- Favicon generado por c√≥digo (SVG) -->
    <link rel="icon"
        href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><defs><linearGradient id=%22g%22 x1=%220%25%22 y1=%220%25%22 x2=%22100%25%22 y2=%22100%25%22><stop offset=%220%25%22 style=%22stop-color:%23006847;stop-opacity:1%22 /><stop offset=%22100%25%22 style=%22stop-color:%23F6C453;stop-opacity:1%22 /></linearGradient></defs><circle cx=%2250%22 cy=%2250%22 r=%2248%22 fill=%22url(%23g)%22 /><path d=%22M50 20c-11 0-20 9-20 20 0 15 20 40 20 40s20-25 20-40c0-11-9-20-20-20zm0 30a10 10 0 110-20 10 10 0 010 20z%22 fill=%22white%22 /><path d=%22M35 45h30M40 35c0 8.3 4.5 15 10 15s10-6.7 10-15%22 fill=%22none%22 stroke=%22rgba(255,255,255,0.3)%22 stroke-width=%222%22/></svg>">


    <style>
        /* Estilos para el modal de Login */
        #login-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 20000;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(8px);
        }

        .login-card {
            background: rgba(30, 60, 114, 0.90);
            border: 1px solid rgba(246, 196, 83, 0.4);
            border-radius: 24px;
            width: 95%;
            max-width: 450px;
            max-height: 90vh;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.7);
            color: white;
            position: relative;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            backdrop-filter: blur(16px);
            animation: modalSlideUp 0.4s cubic-bezier(0.16, 1, 0.3, 1);
        }

        @keyframes modalSlideUp {
            from {
                transform: translateY(30px);
                opacity: 0;
            }

            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .login-scroll-area {
            overflow-y: auto;
            padding: 0 32px 32px 32px;
            flex: 1;
        }

        /* Scrollbar premium para el modal */
        .login-scroll-area::-webkit-scrollbar {
            width: 6px;
        }

        .login-scroll-area::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
        }

        .login-scroll-area::-webkit-scrollbar-thumb {
            background: rgba(246, 196, 83, 0.5);
            border-radius: 10px;
        }

        .login-close-x {
            position: absolute;
            top: 16px;
            right: 16px;
            color: rgba(255, 255, 255, 0.4);
            font-size: 20px;
            cursor: pointer;
            transition: all 0.2s;
            z-index: 10;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
        }

        .login-close-x:hover {
            background: rgba(255, 255, 255, 0.1);
            color: #F6C453;
            transform: rotate(90deg);
        }

        .login-input {
            width: 100%;
            margin-bottom: 16px;
            padding: 12px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            color: white;
        }

        .login-input:focus {
            border-color: #F6C453;
            outline: none;
            background: rgba(255, 255, 255, 0.2);
        }

        .login-submit {
            width: 100%;
            padding: 12px;
            background: #F6C453;
            color: #006847;
            border: none;
            border-radius: 10px;
            font-weight: 800;
            cursor: pointer;
            transition: 0.3s;
        }

        .login-submit:hover {
            background: white;
            transform: scale(1.02);
        }

        body {
            margin: 0;
            min-height: 100vh;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 40%, #2e7d32 70%, #43a047 100%);
            background-attachment: fixed;
            display: flex;
            flex-direction: column;
            overflow-x: hidden;
            font-family: 'Inter', sans-serif;
        }

        main {
            padding: 16px;
            width: 100%;
            max-width: 1920px;
            margin: 0 auto;
            flex: 1;
        }

        @media (min-width: 768px) {
            main {
                padding: 24px;
            }
        }


        .particle {
            position: absolute;
            background: rgba(255, 255, 255, 0.45);
            border-radius: 50%;
            filter: blur(1px);
            animation: floatUp 14s linear infinite;
        }

        @keyframes floatUp {
            0% {
                transform: translateY(100vh) scale(.6);
                opacity: .7;
            }

            50% {
                opacity: 1;
            }

            100% {
                transform: translateY(-30vh) scale(1.3);
                opacity: 0;
            }
        }

        #particle-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            overflow: hidden;
            z-index: -1;
        }

        /* Estilos para la Leyenda */
        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 4px;
            font-size: 11px;
        }

        .legend-color-box {
            width: 12px;
            height: 12px;
            border-radius: 2px;
            display: inline-block;
            border: 1px solid rgba(255, 255, 255, 0.3);
        }
    </style>



    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">


    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <!-- Google Identity Services -->
    <script src="https://accounts.google.com/gsi/client" async defer></script>


    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
    <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>


    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet-easybutton@2/src/easy-button.css">
    <script src="https://cdn.jsdelivr.net/npm/leaflet-easybutton@2/src/easy-button.js"></script>



    <style>
        #map {
            width: 100%;
            height: 100%;
            animation: fadeIn .7s ease-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: scale(.995)
            }

            to {
                opacity: 1;
                transform: scale(1)
            }
        }

        .map-container {
            height: 50vh !important;
            min-height: 350px;
            border-radius: 20px;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.2);
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(4px);
            position: relative;
        }

        @media (min-width: 1024px) {
            .map-container {
                height: 85vh !important;
                border-radius: 24px;
            }
        }

        .sidebar-container {
            display: flex;
            flex-direction: column;
            gap: 12px;
            scrollbar-width: none;
            padding-right: 0;
        }

        @media (min-width: 1024px) {
            .sidebar-container {
                max-height: 85vh;
                overflow-y: auto;
                padding-right: 4px;
                gap: 16px;
            }
        }

        .sidebar-container::-webkit-scrollbar {
            display: none;
        }

        .glass-panel {
            background: rgba(0, 0, 0, 0.45);
            border: 1px solid rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(12px);
            padding: 20px;
            border-radius: 20px;
            color: white;
            width: 100% !important;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            transition: all 0.3s ease;
        }

        .glass-panel h2 {
            color: #F6C453;

        }

        .glass-panel input {
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
        }

        .glass-panel input::placeholder {
            color: rgba(255, 255, 255, 0.6);
        }

        #search-results {
            background: rgba(0, 0, 0, 0.8);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: white;
        }


        .map-control-btn {
            width: 100%;
            padding: 8px 12px;
            margin-bottom: 6px;
            background: rgba(255, 255, 255, 0.15);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            border-radius: 10px;
            font-weight: 600;
            transition: all 0.3s ease;
            backdrop-filter: blur(5px);
            text-align: left;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .map-control-btn:hover {
            background: rgba(255, 255, 255, 0.25);
            transform: translateX(4px);
        }

        .map-control-btn.active {
            background: #F6C453;
            color: #1e3c72;
            border-color: #F6C453;
            box-shadow: 0 0 10px rgba(246, 196, 83, 0.4);
        }

        .map-control-btn::after {
            content: '‚Üí';
            opacity: 0;
            transition: 0.2s;
        }

        .map-control-btn:hover::after,
        .map-control-btn.active::after {
            opacity: 1;
        }


        .leaflet-popup-content-wrapper,
        .leaflet-popup-tip {
            background: rgba(30, 60, 114, 0.9);
            backdrop-filter: blur(8px);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
        }

        .leaflet-popup-content {
            font-family: 'Inter', sans-serif;
            font-size: 14px;
            margin: 12px;
        }

        .leaflet-container a.leaflet-popup-close-button {
            color: #F6C453;
        }


        .service-btn {
            width: 100%;
            text-align: left;
            font-size: 11px;
            padding: 6px 10px;
            margin-bottom: 4px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 6px;
            color: rgba(255, 255, 255, 0.8);
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.2s;
        }

        .service-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            color: white;
        }

        .service-btn.active {
            background: rgba(246, 196, 83, 0.2);
            border-color: #F6C453;
            color: #F6C453;
            font-weight: bold;
        }

        .service-icon {
            width: 16px;
            text-align: center;
        }



        /* Estilos para el men√∫ acorde√≥n de UV */
        .uv-menu-container {
            margin-top: 15px;
            padding-top: 10px;
            border-top: 1px solid rgba(255, 255, 255, 0.2);
            animation: fadeIn 0.5s ease;
        }

        .uv-region-btn {
            width: 100%;
            text-align: left;
            background: rgba(0, 0, 0, 0.2);
            border: none;
            border-left: 3px solid transparent;
            color: rgba(255, 255, 255, 0.9);
            padding: 8px 12px;
            margin-bottom: 4px;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-radius: 4px;
        }

        .uv-region-btn:hover {
            background: rgba(255, 255, 255, 0.15);
            padding-left: 16px;
        }

        .uv-region-btn.active {
            background: rgba(246, 196, 83, 0.15);
            border-left-color: #F6C453 !important;
            /* Forzar el color del borde activo */
            font-weight: bold;
        }

        .uv-arrow {
            display: inline-block;
            transition: transform 0.3s ease;
            font-size: 10px;
        }

        .uv-region-btn.active .uv-arrow {
            transform: rotate(180deg);
        }

        .uv-facultades-list {
            margin-left: 10px;
            padding-left: 10px;
            border-left: 1px solid rgba(255, 255, 255, 0.1);
            overflow: hidden;
            display: none;
            /* Oculto por defecto */
        }

        .uv-facultades-list.open {
            display: block;
            animation: slideDown 0.3s ease;
        }

        .facultad-item {
            font-size: 11px;
            color: rgba(255, 255, 255, 0.7);
            padding: 4px 0;
            cursor: pointer;
            transition: color 0.2s;
        }

        .facultad-item:hover {
            color: #F6C453;
            text-decoration: underline;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-5px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Estilos para el panel de marcado de puntos */
        #point-marker-panel {
            position: fixed;
            top: 0;
            right: -450px;
            width: 420px;
            height: 100vh;
            background: rgba(30, 60, 114, 0.95);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-left: 2px solid rgba(246, 196, 83, 0.3);
            box-shadow: -5px 0 30px rgba(0, 0, 0, 0.5);
            z-index: 10000;
            transition: right 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            overflow-y: auto;
            padding: 24px;
            color: white;
            font-family: 'Inter', sans-serif;
        }

        #point-marker-panel.active {
            right: 0;
        }

        #point-marker-panel h2 {
            color: #F6C453;
            font-size: 22px;
            font-weight: 700;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        #point-marker-panel .form-group {
            margin-bottom: 18px;
        }

        #point-marker-panel label {
            display: block;
            color: #F6C453;
            font-size: 13px;
            font-weight: 600;
            margin-bottom: 6px;
            letter-spacing: 0.5px;
        }

        #point-marker-panel input,
        #point-marker-panel textarea,
        #point-marker-panel select {
            width: 100%;
            padding: 12px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 8px;
            color: white;
            font-size: 14px;
            font-family: 'Inter', sans-serif;
            transition: all 0.3s ease;
        }

        #point-marker-panel input:focus,
        #point-marker-panel textarea:focus,
        #point-marker-panel select:focus {
            outline: none;
            border-color: #F6C453;
            background: rgba(255, 255, 255, 0.15);
            box-shadow: 0 0 15px rgba(246, 196, 83, 0.3);
        }

        #point-marker-panel input::placeholder,
        #point-marker-panel textarea::placeholder {
            color: rgba(255, 255, 255, 0.5);
        }

        #point-marker-panel textarea {
            resize: vertical;
            min-height: 80px;
        }

        #point-marker-panel select {
            cursor: pointer;
        }

        #point-marker-panel select option {
            background: #1e3c72;
            color: white;
        }

        .panel-buttons {
            display: flex;
            gap: 10px;
            margin-top: 24px;
        }

        .panel-btn {
            flex: 1;
            padding: 12px 20px;
            border: none;
            border-radius: 10px;
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .panel-btn-save {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
            box-shadow: 0 4px 15px rgba(16, 185, 129, 0.4);
        }

        .panel-btn-save:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(16, 185, 129, 0.6);
        }

        .panel-btn-cancel {
            background: rgba(255, 255, 255, 0.1);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .panel-btn-cancel:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-2px);
        }

        .panel-btn-delete {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            color: white;
            box-shadow: 0 4px 15px rgba(239, 68, 68, 0.4);
        }

        .panel-btn-delete:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(239, 68, 68, 0.6);
        }

        .close-panel-btn {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 20px;
        }

        .close-panel-btn:hover {
            background: rgba(239, 68, 68, 0.8);
            transform: rotate(90deg);
        }

        /* Estilos sociales */
        .social-btn {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: white;
            font-size: 11px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .social-btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .social-btn.liked {
            color: #ef4444;
            border-color: #ef4444/40;
            background: #ef4444/10;
        }

        #comments-container {
            margin-top: 15px;
            padding-top: 10px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            max-height: 200px;
            overflow-y: auto;
        }

        .comment-item {
            background: rgba(255, 255, 255, 0.05);
            padding: 8px;
            border-radius: 6px;
            margin-bottom: 8px;
            font-size: 11px;
        }

        .comment-item b {
            color: #F6C453;
            display: block;
            margin-bottom: 2px;
        }

        .comment-time {
            font-size: 9px;
            opacity: 0.5;
            display: block;
            margin-top: 4px;
        }

        .upload-area {
            border: 2px dashed rgba(246, 196, 83, 0.3);
            border-radius: 12px;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .upload-area:hover {
            background: rgba(246, 196, 83, 0.05);
            border-color: #F6C453;
        }

        /* Bot√≥n de control para activar modo de marcado */
        .marker-mode-btn {
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 10px 18px;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
        }

        .marker-mode-btn:hover {
            background: rgba(255, 255, 255, 0.25);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        .marker-mode-btn.active {
            background: linear-gradient(135deg, #F6C453, #f59e0b);
            color: #1e3c72;
            border-color: #F6C453;
            box-shadow: 0 0 20px rgba(246, 196, 83, 0.5);
            animation: pulse-glow 2s infinite;
        }

        @keyframes pulse-glow {

            0%,
            100% {
                box-shadow: 0 0 20px rgba(246, 196, 83, 0.5);
            }

            50% {
                box-shadow: 0 0 30px rgba(246, 196, 83, 0.8);
            }
        }

        /* Marcador temporal mientras se arrastra */
        .temp-marker {
            animation: bounce-marker 0.6s ease-in-out infinite;
        }

        @keyframes bounce-marker {

            0%,
            100% {
                transform: translateY(0);
            }

            50% {
                transform: translateY(-10px);
            }
        }

        /* Lista de puntos guardados */
        .saved-points-list {
            margin-top: 20px;
            max-height: 300px;
            overflow-y: auto;
        }

        .saved-point-item {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .saved-point-item:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateX(5px);
            border-color: #F6C453;
        }

        .saved-point-item h4 {
            color: #F6C453;
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .saved-point-item p {
            font-size: 12px;
            color: rgba(255, 255, 255, 0.8);
            margin: 2px 0;
        }

        /* Scrollbar personalizado para el panel */
        #point-marker-panel::-webkit-scrollbar,
        .saved-points-list::-webkit-scrollbar {
            width: 8px;
        }

        #point-marker-panel::-webkit-scrollbar-track,
        .saved-points-list::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 10px;
        }

        #point-marker-panel::-webkit-scrollbar-thumb,
        .saved-points-list::-webkit-scrollbar-thumb {
            background: rgba(246, 196, 83, 0.5);
            border-radius: 10px;
        }

        #point-marker-panel::-webkit-scrollbar-thumb:hover,
        .saved-points-list::-webkit-scrollbar-thumb:hover {
            background: rgba(246, 196, 83, 0.8);
        }

        /* Responsive para el panel */
        @media (max-width: 768px) {
            #point-marker-panel {
                width: 100%;
                right: -100%;
            }
        }
    </style>
</head>

<body>

    <div id="particle-container"></div>
    <script>
        function spawnParticles() {
            const box = document.getElementById("particle-container");
            for (let i = 0; i < 70; i++) {
                const p = document.createElement("div");
                p.classList.add("particle");
                p.style.left = Math.random() * 100 + "vw";
                p.style.top = Math.random() * 100 + "vh";
                const size = Math.random() * 8 + 6;
                p.style.width = size + "px";
                p.style.height = size + "px";
                p.style.animationDelay = Math.random() * 12 + "s";
                box.appendChild(p);
            }
        }
        spawnParticles();


    </script>


    <nav class="bg-[#006847] text-white py-3 px-6 shadow-lg relative z-50">
        <div class="max-w-7xl mx-auto flex justify-between items-center gap-2 md:gap-4">

            <!-- Izquierda: Universidad Veracruzana -->
            <div class="flex items-center gap-2 md:gap-4 flex-1 min-w-0">
                <img src="zLogosimbolo_color.jpg" class="h-10 md:h-14 bg-white/90 rounded-full p-1 shadow-sm shrink-0"
                    alt="Logo UV" />
                <h1 class="font-bold text-[10px] md:text-lg leading-tight truncate">
                    Universidad <br class="hidden sm:block">Veracruzana
                </h1>
            </div>

            <!-- Centro: T√≠tulo Mapa -->
            <div class="flex-[1.5] text-center">
                <h2
                    class="text-sm md:text-2xl font-black text-[#F6C453] tracking-wider uppercase drop-shadow-md whitespace-nowrap">
                    Mapa Interactivo
                </h2>
                <div class="h-1 w-12 md:w-20 bg-[#F6C453] mx-auto mt-0.5 md:mt-1 rounded-full opacity-80"></div>
            </div>

            <!-- Derecha: Licenciatura y Login -->
            <div class="flex-1 text-right flex justify-end items-center min-w-0 gap-3">
                <div class="border-l border-[#F6C453]/30 md:border-l-2 pl-2 md:pl-4">
                    <p
                        class="text-[9px] md:text-sm font-semibold leading-tight uppercase tracking-tight md:tracking-normal">
                        Licenciatura <br class="hidden sm:block"> en Geograf√≠a
                    </p>
                </div>
                <div id="auth-container">
                    <button onclick="openLoginModal()" id="login-btn"
                        class="bg-[#F6C453] text-[#006847] px-3 py-1 md:px-4 md:py-2 rounded-lg font-bold text-[10px] md:text-xs uppercase hover:bg-white transition-all shadow-md">
                        <i class="fas fa-sign-in-alt"></i> Login
                    </button>
                    <div id="user-logged-in" class="hidden flex items-center gap-2">
                        <span id="username-display" class="text-[10px] md:text-xs font-bold text-[#F6C453]"></span>
                        <button onclick="logout()"
                            class="text-white hover:text-red-400 text-[10px] md:text-xs underline p-1">Salir</button>
                    </div>
                </div>
            </div>

        </div>
    </nav>


    <main>
        <div class="grid grid-cols-1 lg:grid-cols-12 gap-6 h-full">

            <!-- Columna del Men√∫ (Verde en tu dibujo) -->
            <aside class="lg:col-span-3 xl:col-span-2 order-2 lg:order-1 sidebar-container">

                <button id="marker-mode-toggle" class="marker-mode-btn w-full mb-2" onclick="toggleMarkerMode()">
                    <i class="fas fa-map-marker-alt"></i>
                    <span>Marcar Puntos Personalizados</span>
                </button>

                <button id="admin-panel-btn" class="marker-mode-btn w-full mb-2 hidden bg-[#1e3c72] hover:bg-[#3b82f6]"
                    onclick="openAdminTable()">
                    <i class="fas fa-cog"></i>
                    <span>Gesti√≥n de Datos (Admin)</span>
                </button>

                <div class="glass-panel">
                    <h2 class="font-semibold mb-2">Buscar municipio</h2>
                    <div style="position: relative;">
                        <input id="search-input" type="text" placeholder="Escribe un municipio..."
                            class="w-full p-2 rounded-lg text-sm focus:ring-2 focus:ring-[#F6C453] outline-none" />
                        <ul id="search-results"
                            class="absolute z-[1000] w-full mt-1 max-h-60 overflow-y-auto hidden glass-panel !p-0 border border-white/20 shadow-2xl">
                        </ul>
                        <button id="clear-search" onclick="clearMunicipioFilter()"
                            style="position: absolute; right: 8px; top: 50%; transform: translateY(-50%); background: rgba(239,68,68,0.8); color: white; border: none; border-radius: 4px; padding: 4px 8px; font-size: 11px; cursor: pointer; display: none;"
                            title="Limpiar b√∫squeda">
                            ‚úï
                        </button>
                    </div>
                </div>

                <div class="glass-panel">
                    <h2 class="font-semibold mb-2">Buscador de Puntos</h2>
                    <div class="relative mb-4">
                        <i class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-white/40 text-xs"></i>
                        <input type="text" id="point-search-input" oninput="filterCustomPoints()"
                            placeholder="Buscar por nombre..."
                            class="w-full p-2 pl-8 rounded-lg text-xs focus:ring-2 focus:ring-[#F6C453] outline-none bg-white/10 border border-white/20 text-white" />
                    </div>

                    <div class="category-filters space-y-2">
                        <label class="text-[10px] uppercase tracking-wider text-[#F6C453] font-bold opacity-80">Filtrar
                            por Categor√≠a</label>
                        <div id="category-checkboxes" class="grid grid-cols-1 gap-1">
                            <!-- Se genera din√°micamente -->
                        </div>
                    </div>
                </div>

                <div class="glass-panel">
                    <h2 class="font-semibold mb-2">Escalas</h2>
                    <div id="map-controls"></div>
                    <div id="uv-menu-container" class="mt-2"></div>
                </div>

                <div id="info-panel" class="glass-panel hidden">
                    <h2 id="info-title" class="font-semibold mb-2"></h2>
                    <div id="info-content" class="text-xs text-white/90"></div>
                </div>

                <div class="glass-panel">
                    <h2 class="font-semibold mb-2">Leyenda</h2>
                    <div id="map-legend" class="text-xs"></div>
                </div>
            </aside>

            <!-- Columna del Mapa (Naranja en tu dibujo) -->
            <div class="lg:col-span-9 xl:col-span-10 order-1 lg:order-2 h-full">
                <div class="map-container shadow-2xl">
                    <div id="map"></div>
                </div>
            </div>

        </div>
    </main>





    <!-- Panel lateral para marcar puntos personalizados -->
    <div id="point-marker-panel">
        <button class="close-panel-btn" onclick="closeMarkerPanel()">‚úï</button>

        <h2>
            <i class="fas fa-map-pin"></i>
            Punto Personalizado
        </h2>

        <form id="point-form" onsubmit="saveCustomPoint(event)">
            <div class="form-group">
                <label for="point-name">
                    <i class="fas fa-tag"></i> Nombre del Punto *
                </label>
                <input type="text" id="point-name" placeholder="Ej: Oficina Central, Punto de Inter√©s..." required />
            </div>

            <div class="form-group">
                <label for="point-category">
                    <i class="fas fa-folder"></i> Categor√≠a *
                </label>
                <select id="point-category" required onchange="updateSubcategories()">
                    <option value="">Selecciona una categor√≠a</option>
                    <option value="comercio">üè™ Comercio</option>
                    <option value="oficina">üè¢ Oficina</option>
                    <option value="educacion">üéì Educaci√≥n</option>
                    <option value="salud">üè• Salud</option>
                    <option value="recreacion">üéØ Recreaci√≥n</option>
                    <option value="transporte">üöå Transporte</option>
                    <option value="gobierno">üèõÔ∏è Gobierno</option>
                    <option value="otro">üìç Otro</option>
                </select>
            </div>

            <div class="form-group" id="subcategory-group">
                <label for="point-subcategory">
                    <i class="fas fa-sitemap"></i> Subcategor√≠a *
                </label>
                <select id="point-subcategory" required disabled>
                    <option value="">Primero selecciona una categor√≠a</option>
                </select>
            </div>

            <div class="form-group">
                <label for="point-description">
                    <i class="fas fa-align-left"></i> Descripci√≥n (m√°x 500 car.)
                </label>
                <textarea id="point-description" maxlength="500"
                    placeholder="Describe brevemente este lugar..."></textarea>
            </div>

            <div class="form-group">
                <label>
                    <i class="fas fa-camera"></i> Imagen del Punto
                </label>
                <div class="upload-area" onclick="document.getElementById('file-upload').click()">
                    <i class="fas fa-cloud-upload-alt text-2xl text-[#F6C453] mb-2"></i>
                    <p class="text-xs opacity-70">Haz clic para subir desde tu celular o PC</p>
                    <p id="upload-status" class="text-[10px] text-[#10b981] mt-1 font-bold"></p>
                </div>
                <input type="file" id="file-upload" class="hidden" accept="image/*" onchange="handleFileUpload(this)" />
                <input type="hidden" id="point-image" />
                <p class="text-[9px] opacity-50 mt-1">O pega una URL directa:</p>
                <input type="url" id="point-image-url" placeholder="https://ejemplo.com/foto.jpg"
                    oninput="document.getElementById('point-image').value = this.value" class="login-input mt-1"
                    style="font-size: 10px; padding: 8px;" />
            </div>

            <div class="form-group">
                <label for="point-address">
                    <i class="fas fa-map-marker-alt"></i> Direcci√≥n
                </label>
                <input type="text" id="point-address" placeholder="Calle, n√∫mero, colonia..." />
            </div>

            <div class="form-group">
                <label>
                    <i class="fas fa-crosshairs"></i> Coordenadas (Geogr√°ficas y UTM)
                </label>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 8px;">
                    <div>
                        <span style="font-size: 10px; color: rgba(255,255,255,0.6);">Latitud (DD)</span>
                        <input type="number" id="point-lat" step="any" readonly
                            style="background: rgba(255, 255, 255, 0.05); font-size: 12px;" />
                    </div>
                    <div>
                        <span style="font-size: 10px; color: rgba(255,255,255,0.6);">Longitud (DD)</span>
                        <input type="number" id="point-lng" step="any" readonly
                            style="background: rgba(255, 255, 255, 0.05); font-size: 12px;" />
                    </div>
                </div>
                <!-- Formatos adicionales -->
                <div
                    style="background: rgba(0,0,0,0.2); border-radius: 8px; padding: 10px; font-size: 11px; line-height: 1.6;">
                    <div id="coord-dms" style="color: #F6C453;">DMS: Calculando...</div>
                    <div id="coord-utm" style="color: #6366f1; margin-top: 4px;">UTM: Calculando...</div>
                </div>
            </div>

            <div class="panel-buttons">
                <button type="submit" class="panel-btn panel-btn-save">
                    <i class="fas fa-save"></i>
                    Guardar
                </button>
                <button type="button" class="panel-btn panel-btn-cancel" onclick="closeMarkerPanel()">
                    <i class="fas fa-times"></i>
                    Cancelar
                </button>
            </div>

            <div id="delete-button-container" style="display: none;">
                <button type="button" class="panel-btn panel-btn-delete" onclick="deleteCurrentPoint()"
                    style="width: 100%; margin-top: 10px;">
                    <i class="fas fa-trash"></i>
                    Eliminar
                </button>
            </div>
        </form>

        <!-- Lista de puntos guardados -->
        <div style="margin-top: 30px; padding-top: 20px; border-top: 1px solid rgba(255, 255, 255, 0.2);">
            <h3 style="color: #F6C453; font-size: 16px; font-weight: 600; margin-bottom: 12px;">
                <i class="fas fa-list"></i> Puntos Guardados (<span id="saved-points-count">0</span>)
            </h3>
            <div id="saved-points-list" class="saved-points-list">
                <p style="text-align: center; color: rgba(255, 255, 255, 0.5); font-size: 13px;">
                    No hay puntos guardados a√∫n
                </p>
            </div>
        </div>
    </div>


    <script>


        // Configuraci√≥n para el despliegue h√≠brido (GitHub + Render)
        const API_BASE_URL = 'https://sig-web-uv.onrender.com';

        async function apiFetch(endpoint, options = {}) {
            const url = endpoint.startsWith('http') ? endpoint : `${API_BASE_URL}${endpoint}`;
            try {
                return await fetch(url, options);
            } catch (error) {
                if (error.message.includes('Failed to fetch')) {
                    showNotification('El servidor despertando... espera un momento ‚è≥', 'info');
                }
                throw error;
            }
        }

        function getFullUrl(path) {
            if (!path) return '';
            if (path.startsWith('http')) return path;
            return `${API_BASE_URL}${path.startsWith('/') ? '' : '/'}${path}`;
        }

        var map = L.map('map', { zoomControl: false }).setView([19.17, -96.13], 7);
        let currentScale = 'nacional'; // Track current scale


        const baseLayers = {
            'Mapa Claro': L.tileLayer('https://cartodb-basemaps-a.global.ssl.fastly.net/light_all/{z}/{x}/{y}.png', {
                attribution: '&copy; OpenStreetMap ¬∑ CartoDB',
                maxZoom: 19
            }),
            'Sat√©lite H√≠brido': L.layerGroup([
                L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
                    attribution: '&copy; Esri',
                    maxZoom: 19
                }),
                L.tileLayer('https://cartodb-basemaps-a.global.ssl.fastly.net/dark_only_labels/{z}/{x}/{y}.png', {
                    attribution: '&copy; CartoDB',
                    maxZoom: 19,
                    pane: 'markerPane'
                })
            ])
        };


        let currentBaseLayer = baseLayers['Mapa Claro'];
        currentBaseLayer.addTo(map);


        const BaseLayerControl = L.Control.extend({
            options: { position: 'topright' },
            onAdd: function (map) {
                const container = L.DomUtil.create('div', 'leaflet-bar leaflet-control');
                container.style.cssText = `
          background: rgba(255, 255, 255, 0.15);
          backdrop-filter: blur(10px);
          border: 1px solid rgba(255, 255, 255, 0.3);
          border-radius: 12px;
          padding: 8px;
          margin-top: 60px;
        `;

                container.innerHTML = `
          <div style="color: white; font-size: 11px; font-weight: bold; margin-bottom: 6px; text-align: center;">
            CAPAS BASE
          </div>
          <select id="base-layer-selector" style="
            width: 100%;
            padding: 6px;
            border-radius: 6px;
            border: 1px solid rgba(255,255,255,0.3);
            background: rgba(0,0,0,0.3);
            color: white;
            font-size: 11px;
            cursor: pointer;
            outline: none;
          ">
            <option value="Mapa Claro">üó∫Ô∏è Mapa Claro</option>
            <option value="Sat√©lite H√≠brido">üõ∞Ô∏è Sat√©lite H√≠brido</option>
          </select>
        `;

                // Prevenir que el click en el control afecte el mapa
                L.DomEvent.disableClickPropagation(container);

                return container;
            }
        });

        map.addControl(new BaseLayerControl());


        function changeBaseLayer(layerName) {
            if (currentBaseLayer) {
                map.removeLayer(currentBaseLayer);
            }
            currentBaseLayer = baseLayers[layerName];
            currentBaseLayer.addTo(map);


            if (currentBaseLayer.bringToBack) {
                currentBaseLayer.bringToBack();
            } else if (currentBaseLayer.eachLayer) {
                currentBaseLayer.eachLayer(layer => {
                    if (layer.bringToBack) layer.bringToBack();
                });
            }

            console.log(`Capa base cambiada a: ${layerName}`);


            if (currentScale === 'nacional' && map.hasLayer(layers.nacional)) {

                layers.nacional.clearLayers();


                fetch('Nacional_opt.geojson').then(r => r.json()).then(data => {
                    const isDarkLayer = (layerName === 'Sat√©lite H√≠brido');

                    const nationalStyle = isDarkLayer ?
                        { color: '#F6C453', weight: 2, fillOpacity: 0.25, fillColor: '#F6C453' } :
                        { color: '#000', weight: 2, fillOpacity: 0.35, fillColor: '#555' };

                    L.geoJSON(data, { style: nationalStyle }).addTo(layers.nacional);
                    console.log(`Pol√≠gono nacional actualizado para capa ${layerName}`);
                }).catch(e => console.warn("Error actualizando pol√≠gono nacional", e));
            }
        }


        setTimeout(() => {
            const selector = document.getElementById('base-layer-selector');
            if (selector) {
                selector.addEventListener('change', (e) => {
                    changeBaseLayer(e.target.value);
                });
            }
        }, 100);


        L.control.zoom({ position: 'bottomright' }).addTo(map);
        L.control.scale({ position: 'bottomleft', imperial: false }).addTo(map);



        L.easyButton('<span title="Centro">‚§í</span>', function (btn, m) {
            map.setView([19.17, -96.13], 7);
        }).addTo(map);


        var compassControl = L.Control.extend({
            options: { position: 'topright' },
            onAdd: function (map) {
                var div = L.DomUtil.create('div', 'compass-control');
                div.innerHTML = `
          <svg width="50" height="50" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg" style="filter: drop-shadow(0 2px 4px rgba(0,0,0,0.5));">
            <path d="M50 0 L65 40 L100 50 L65 60 L50 100 L35 60 L0 50 L35 40 Z" fill="rgba(30, 60, 114, 0.8)" stroke="#F6C453" stroke-width="2"/>
            <path d="M50 0 L50 100 M0 50 L100 50" stroke="rgba(255,255,255,0.3)" stroke-width="1"/>
            <text x="50" y="24" font-family="Inter, sans-serif" font-size="16" font-weight="900" fill="#F6C453" text-anchor="middle">N</text>
          </svg>
        `;
                div.style.marginTop = '10px';
                div.style.marginRight = '10px';
                return div;
            }
        });
        map.addControl(new compassControl());


        var layers = {
            nacional: L.featureGroup(),
            estatal: L.featureGroup(),
            municipios: L.featureGroup(),
            regionesUV: L.featureGroup(),
            servicios: { 1: L.layerGroup(), 2: L.layerGroup(), 3: L.layerGroup(), 4: L.layerGroup(), 5: L.layerGroup() }
        };

        var highlightLayer = L.geoJSON(null, {
            style: {
                color: "#1affff", // Cyan brillante para resaltar sobre rojos del mapa tem√°tico
                weight: 6,
                fillOpacity: 0.3,
                opacity: 1,
                dashArray: '3'
            }
        }).addTo(map);


        var highlightLabel = null;


        function applyGlowToLayer(geoLayer) {
            try {
                geoLayer.eachLayer(l => {
                    const el = l.getElement ? l.getElement() : null;
                    if (el) {
                        el.classList.add('glow', 'pulse');
                    } else {

                        setTimeout(() => { try { l.getElement().classList.add('glow', 'pulse'); } catch (e) { } }, 50);
                    }
                });
            } catch (e) {
                console.warn("applyGlowToLayer error", e);
            }
        }


        function updateLabelPosition() {
            if (highlightLabel && highlightLayer && highlightLayer.getLayers().length > 0) {
                try {
                    const bounds = highlightLayer.getBounds();
                    if (bounds.isValid()) {
                        const c = bounds.getCenter();
                        highlightLabel.setLatLng(c);
                    }
                } catch (e) { }
            }
        }
        map.on('zoomend', updateLabelPosition);
        map.on('moveend', updateLabelPosition);


        let sidebarPointId = null;

        function abrirPanel(titulo, contenido, pointId = null) {
            document.getElementById('info-title').innerHTML = titulo;
            document.getElementById('info-content').innerHTML = contenido;
            document.getElementById('info-panel').classList.remove('hidden');
            sidebarPointId = pointId;
        }


        function getColor(d) {
            return d > 500000 ? '#bd0026' :
                d > 250000 ? '#f03b20' :
                    d > 100000 ? '#fd8d3c' :
                        d > 50000 ? '#feb24c' :
                            d > 25000 ? '#fed976' :
                                d > 10000 ? '#ffeda0' :
                                    '#ffffcc';
        }

        function mergePopulationData() {
            if (!municipalGeoJSON || !poblacion || !poblacion.municipios) return;
            municipalGeoJSON.features.forEach(f => {
                const match = poblacion.municipios.find(m => m.NOMGEO === f.properties.NOMGEO);
                if (match) {
                    f.properties.POB1 = match.POB1;
                    f.properties.POB84 = match.POB84;
                    f.properties.POB42 = match.POB42;
                }
            });

            // Si la capa de municipios ya fue creada, forzar actualizaci√≥n de estilo
            if (layers.municipios && layers.municipios.getLayers().length > 0) {
                layers.municipios.eachLayer(layer => {
                    if (layer.setStyle) {
                        layer.setStyle({
                            fillColor: getColor(layer.feature.properties.POB1 || 0)
                        });
                    }
                });
            }
        }

        function actualizarLeyenda(tipo, data = null) {
            const node = document.getElementById('map-legend');
            let content = "";
            let p = data;

            if (tipo === 'nacional') {
                content = `<b>Nacional</b><br><span class="legend-color-box" style="background:black"></span> Pol√≠gono Nacional`;
                if (!p && typeof poblacion !== 'undefined') p = poblacion.nacional;
            } else if (tipo === 'estatal') {
                content = `<b>Estatal</b><br><span class="legend-color-box" style="background:#006847"></span> Veracruz`;
                if (!p && typeof poblacion !== 'undefined') p = poblacion.veracruz;
            } else if (tipo === 'municipios') {
                content = `<b>Poblaci√≥n Municipal</b><br>
                    <div class="legend-item"><span class="legend-color-box" style="background:#bd0026"></span> +500,000</div>
                    <div class="legend-item"><span class="legend-color-box" style="background:#f03b20"></span> 250,000 - 500,000</div>
                    <div class="legend-item"><span class="legend-color-box" style="background:#fd8d3c"></span> 100,000 - 250,000</div>
                    <div class="legend-item"><span class="legend-color-box" style="background:#feb24c"></span> 50,000 - 100,000</div>
                    <div class="legend-item"><span class="legend-color-box" style="background:#fed976"></span> 25,000 - 50,000</div>
                    <div class="legend-item"><span class="legend-color-box" style="background:#ffeda0"></span> 10,000 - 25,000</div>
                    <div class="legend-item"><span class="legend-color-box" style="background:#ffffcc"></span> < 10,000</div>`;
            } else if (tipo === 'regiones_uv') {
                content = `<b>Regiones UV</b><br>`;
                const uvColors = {
                    'Poza Rica-Tuxpan': '#F59E0B',
                    'Xalapa': '#3B82F6',
                    'Veracruz': '#EF4444',
                    'Orizaba-C√≥rdoba': '#10B981',
                    'Coatzacoalcos-Minatitl√°n': '#8B5CF6'
                };
                Object.keys(uvColors).forEach(k => {
                    content += `<div style="margin-top:6px"><span class="legend-color-box" style="background:${uvColors[k]}"></span> ${k}</div>`;
                });
            }

            if (p && p.POB1) {
                const nombre = p.NOMGEO || (tipo === 'estatal' ? 'Veracruz' : 'M√©xico');
                content += `
                    <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid rgba(255,255,255,0.1); font-size: 10px; line-height: 1.4; opacity: 0.9;">
                        <div style="color:#F6C453; font-weight:bold; margin-bottom:4px; text-transform:uppercase;">${nombre}</div>
                        poblacion total: <b style="color:#fff">${p.POB1.toLocaleString()}</b><br>
                        poblacion hombres: <b style="color:#3B82F6">${(p.POB84 || 0).toLocaleString()}</b><br>
                        poblacion mujeres: <b style="color:#F472B6">${(p.POB42 || 0).toLocaleString()}</b>
                    </div>
                `;
            } else if (tipo === 'municipios' && !p) {
                content += `<div style="margin-top:8px; font-size:9px; opacity:0.6;">(Selecciona un municipio para ver poblaci√≥n)</div>`;
            }

            node.innerHTML = content;
        }


        function clearAll() {
            // limpiar resaltado
            try {
                highlightLayer.clearLayers();
            } catch (e) { }

            if (highlightLabel) {
                try { map.removeLayer(highlightLabel); } catch (e) { }
                highlightLabel = null;
            }


            try { map.removeLayer(layers.nacional); } catch (e) { }
            try { map.removeLayer(layers.estatal); } catch (e) { }
            try { map.removeLayer(layers.municipios); } catch (e) { }
            try { map.removeLayer(layers.regionesUV); } catch (e) { }


        }


        function mostrarInfoMunicipio(cve, nombre) {
            abrirPanel("Municipio: " + nombre, `
                <p class="mb-4 text-sm opacity-90">Datos del municipio.</p>
                <!-- Aqu√≠ se mostrar√°n los datos creados por el usuario -->
            `);
        }

        function showMunicipalities() {
            currentScale = 'municipios';
            setActiveBtn('btn-municipios');
            clearAll();
            actualizarLeyenda('municipios');
            // updateServicePointsForScale(); // Eliminado


            try {
                if (layers.municipios && layers.municipios.getLayers && layers.municipios.getLayers().length > 0) {
                    layers.municipios.addTo(map);

                    try {
                        map.fitBounds(layers.municipios.getBounds(), { padding: [30, 30] });
                    } catch (e) { }
                    return;
                }
            } catch (e) {

            }


            fetch('Municipal_opt.geojson').then(r => r.json()).then(data => {
                const layer = L.geoJSON(data, {
                    style: { color: '#006847', weight: 1, fillOpacity: 0.18 },
                    onEachFeature: (f, l) => { l.on('click', () => mostrarInfoMunicipio(f.properties.CVEGEO, f.properties.NOMGEO)); }
                }).addTo(layers.municipios);

                layers.municipios.addTo(map);
                try { map.fitBounds(layer.getBounds(), { padding: [30, 30] }); } catch (e) { }
            }).catch(e => console.warn("Municipal_opt.geojson error", e));
        }

        const uvRegionsData = {
            "Poza Rica-Tuxpan": {
                color: "#F59E0B",
                municipios: ["Poza Rica de Hidalgo", "Tuxpan", "Ixhuatl√°n de Madero", "Espinal", "Papantla"],
                facultades: [
                    "Facultad de Medicina",
                    "Facultad de Ingenier√≠a y Ciencias Qu√≠micas",
                    "Facultad de Pedagog√≠a",
                    "Facultad de Trabajo Social",
                    "Facultad de Arquitectura"
                ]
            },
            "Xalapa": {
                color: "#3B82F6",
                municipios: ["Xalapa", "Naolinco", "Perote", "Ixhuac√°n de los Reyes"],
                facultades: [
                    "Facultad de Derecho",
                    "Facultad de Econom√≠a",
                    "Facultad de Estad√≠stica e Inform√°tica",
                    "Facultad de Humanidades",
                    "Facultad de Biolog√≠a",
                    "Facultad de Artes Pl√°sticas",
                    "Facultad de M√∫sica"
                ]
            },
            "Veracruz": {
                color: "#EF4444",
                municipios: ["Veracruz", "Boca del R√≠o"],
                facultades: [
                    "Facultad de Medicina",
                    "Facultad de Administraci√≥n",
                    "Facultad de Ciencias de la Comunicaci√≥n",
                    "Facultad de Bioan√°lisis",
                    "Facultad de Ingenier√≠a"
                ]
            },
            "Orizaba-C√≥rdoba": {
                color: "#10B981",
                municipios: ["Orizaba", "C√≥rdoba", "Camerino Z. Mendoza", "Ciudad Mendoza", "Nogales", "R√≠o Blanco", "Amatl√°n de los Reyes", "Tequila"],
                facultades: [
                    "Facultad de Ciencias Qu√≠micas",
                    "Facultad de Enfermer√≠a",
                    "Facultad de Odontolog√≠a",
                    "Facultad de Arquitectura"
                ]
            },
            "Coatzacoalcos-Minatitl√°n": {
                color: "#8B5CF6",
                municipios: ["Coatzacoalcos", "Minatitl√°n", "Acayucan", "Agua Dulce", "Mecayapan", "Uxpanapa"],
                facultades: [
                    "Facultad de Contadur√≠a y Administraci√≥n",
                    "Facultad de Ingenier√≠a",
                    "Facultad de Ciencias Qu√≠micas",
                    "Escuela de Enfermer√≠a"
                ]
            }
        };

        function mostrarInfoRegionUV(nombre) {
            // Panel informativo simple
            const data = uvRegionsData[nombre];
            if (!data) return;
            abrirPanel("Regi√≥n: " + nombre, `
                <p class="mb-2 text-sm">Sede de importantes facultades.</p>
                <p class="text-[11px] mb-2"><b>Campus Principal:</b> Varios</p>
                <p class="text-[10px] opacity-70">Selecciona una facultad del men√∫ para m√°s detalles.</p>
            `);
        }

        function toggleFacultades(regionName) {
            const safeId = regionName.replace(/\s+/g, '-');
            const listId = 'list-' + safeId;
            const btnId = 'btn-region-' + safeId;

            const list = document.getElementById(listId);
            const btn = document.getElementById(btnId);

            const allLists = document.querySelectorAll('.uv-facultades-list');
            const allBtns = document.querySelectorAll('.uv-region-btn'); // Nueva clase a controlar

            // Estado actual
            const isAbierto = list && list.classList.contains('open');

            // 1. Cerrar TODO active state y open lists
            allLists.forEach(l => l.classList.remove('open'));
            allBtns.forEach(b => b.classList.remove('active'));

            // 2. Si estaba CERRADO, lo abrimos y activamos
            if (!isAbierto && list) {
                list.classList.add('open');
                if (btn) btn.classList.add('active'); // Rotar√° la flecha
            }
        }

        function mostrarDetalleFacultad(facultad) {
            // Al hacer clic en una facultad
            abrirPanel("Facultad", `
             <h3 class="text-lg font-bold text-[#F6C453] mb-2">${facultad}</h3>
             <p class="text-sm">Informaci√≥n detallada sobre programas educativos, ubicaci√≥n y contacto.</p>
             <p class="text-xs mt-2 opacity-70">(Informaci√≥n por cargar)</p>
           `);
        }

        function showUVRegions() {
            currentScale = 'regiones_uv';
            // updateServicePanelVisibility(); 
            setActiveBtn('btn-regiones-uv');
            clearAll();
            actualizarLeyenda('regiones_uv');
            // updateServicePointsForScale(); 

            // Generar Men√∫ Acorde√≥n
            const existingContainer = document.getElementById('uv-menu-container');
            let container = existingContainer; // Usar el ID correcto

            // Parche: Si no existe el contenedor, crearlo din√°micamente despu√©s del bot√≥n
            if (!container) {
                const btn = document.getElementById('btn-regiones-uv');
                if (btn && btn.parentNode) {
                    container = document.createElement('div');
                    container.id = 'uv-menu-container';
                    container.className = 'uv-menu-container hidden';
                    // Intenta insertarlo despu√©s del bot√≥n
                    if (btn.nextSibling) {
                        btn.parentNode.insertBefore(container, btn.nextSibling);
                    } else {
                        btn.parentNode.appendChild(container);
                    }
                }
            }

            if (container) {
                container.innerHTML = ''; // Limpiar
                container.classList.remove('hidden'); // Mostrar contenedor

                Object.keys(uvRegionsData).forEach(region => {
                    const data = uvRegionsData[region];
                    const safeId = region.replace(/\s+/g, '-');

                    // Crear HTML del item con ID de bot√≥n y flecha
                    const itemHTML = `
                        <div class="mb-1">
                            <button id="btn-region-${safeId}" class="uv-region-btn" onclick="toggleFacultades('${region}')" style="border-left-color: ${data.color}">
                                ${region} <span class="uv-arrow">‚ñº</span>
                            </button>
                            <div id="list-${safeId}" class="uv-facultades-list">
                                ${data.facultades.map(f => `<div class="facultad-item" onclick="mostrarDetalleFacultad('${f}')">‚Ä¢ ${f}</div>`).join('')}
                            </div>
                        </div>
                    `;
                    container.innerHTML += itemHTML;
                });
            }

            // Cargar geojson municipal y filtrar (L√≥gica de mapa)
            fetch('Municipal_opt.geojson').then(r => r.json()).then(data => {
                const layer = L.geoJSON(data, {
                    style: (feature) => {
                        const nom = feature.properties.NOMGEO;
                        let regionColor = null;

                        // Buscar a qu√© regi√≥n pertenece
                        for (const [key, val] of Object.entries(uvRegionsData)) {
                            // Comparaci√≥n normalizada para evitar errores de acentos/may√∫sculas
                            if (val.municipios.some(m => normalizar(m) === normalizar(nom))) {
                                regionColor = val.color;
                                feature.properties.uvRegion = key; // Guardar regi√≥n en propiedades
                                break;
                            }
                        }

                        if (regionColor) {
                            return { color: 'white', weight: 1, fillColor: regionColor, fillOpacity: 0.6 };
                        } else {
                            // Municipios NO UV: gris muy transparente y sin borde
                            return { color: 'transparent', weight: 0, fillColor: '#ccc', fillOpacity: 0.1 };
                        }
                    },
                    onEachFeature: (f, l) => {
                        if (f.properties.uvRegion) {
                            l.on('click', () => {
                                // Al hacer clic en mapa, abrimos tambi√©n su men√∫ correspondiente
                                toggleFacultades(f.properties.uvRegion);
                                mostrarInfoRegionUV(f.properties.uvRegion);

                                l.setStyle({ fillOpacity: 0.8 });
                                setTimeout(() => l.setStyle({ fillOpacity: 0.6 }), 500);
                            });

                            l.bindTooltip(f.properties.NOMGEO, { direction: 'center', className: 'text-xs', permanent: false });

                            l.on('mouseover', () => {
                                l.setStyle({ weight: 2, color: 'white', fillOpacity: 0.8 });
                                l.getElement()?.classList.add('glow');
                            });
                            l.on('mouseout', () => {
                                l.setStyle({ weight: 1, color: 'white', fillOpacity: 0.6 });
                                l.getElement()?.classList.remove('glow');
                            });
                        } else {
                            // Desactivar interacci√≥n para municipios no UV
                            l.off('click');
                        }
                    }
                }).addTo(layers.regionesUV);

                layers.regionesUV.addTo(map);
                try { map.fitBounds(layer.getBounds(), { padding: [30, 30] }); } catch (e) { }
            }).catch(e => console.warn("Error cargando municipios para UV", e));
        }



    </script>

    <script>

        function showState() {
            currentScale = 'estatal';
            // updateServicePanelVisibility(); // Eliminado
            setActiveBtn('btn-estatal');
            clearAll();
            actualizarLeyenda('estatal');
            // updateServicePointsForScale(); // Eliminado

            fetch('Veracruz.geojson').then(r => r.json()).then(data => {
                const layer = L.geoJSON(data, { style: { color: '#006847', weight: 2, fillOpacity: 0.2 } }).addTo(layers.estatal);
                try { map.fitBounds(layer.getBounds(), { padding: [30, 30] }); } catch (e) { }
            }).catch(e => console.warn("Veracruz.geojson error", e));

            layers.estatal.addTo(map);


            if (poblacion.veracruz && poblacion.veracruz.POB1) {
                const pv = poblacion.veracruz;
                abrirPanel("Informaci√≥n Estatal (Veracruz)", `
      <ul class="list-disc ml-4">
        <li>Poblaci√≥n Total: <b>${pv.POB1.toLocaleString()}</b></li>
        <li>Hombres: <b>${pv.POB84.toLocaleString()}</b></li>
        <li>Mujeres: <b>${pv.POB42.toLocaleString()}</b></li>
      </ul>
    `);
            }
        }


        function showNational() {
            currentScale = 'nacional';
            // updateServicePanelVisibility(); // Eliminado
            setActiveBtn('btn-nacional');
            clearAll();
            actualizarLeyenda('nacional');
            // updateServicePointsForScale(); // Eliminado

            fetch('Nacional_opt.geojson').then(r => r.json()).then(data => {

                const isDarkLayer = (currentBaseLayer === baseLayers['CartoDB Dark'] ||
                    currentBaseLayer === baseLayers['Sat√©lite']);

                const nationalStyle = isDarkLayer ?
                    { color: '#F6C453', weight: 2, fillOpacity: 0.25, fillColor: '#F6C453' } :
                    { color: '#000', weight: 2, fillOpacity: 0.35, fillColor: '#555' };

                const layer = L.geoJSON(data, { style: nationalStyle }).addTo(layers.nacional);
                try { map.fitBounds(layer.getBounds(), { padding: [30, 30] }); } catch (e) { }
            }).catch(e => console.warn("Nacional_opt.geojson error", e));

            layers.nacional.addTo(map);

            if (poblacion.nacional && poblacion.nacional.POB1) {
                const pn = poblacion.nacional;
                abrirPanel("Informaci√≥n Nacional", `
      <ul class="list-disc ml-4">
        <li>Poblaci√≥n Total: <b>${pn.POB1.toLocaleString()}</b></li>
        <li>Hombres: <b>${pn.POB84.toLocaleString()}</b></li>
        <li>Mujeres: <b>${pn.POB42.toLocaleString()}</b></li>
      </ul>
    `);
            }
        }


        document.getElementById('map-controls').innerHTML = `
      <button id="btn-nacional" onclick="showNational()" class="map-control-btn">Nacional</button>
      <button id="btn-estatal" onclick="showState()" class="map-control-btn">Estatal</button>
      <button id="btn-municipios" onclick="showMunicipalities()" class="map-control-btn">Municipios</button>
      <button id="btn-regiones-uv" onclick="showUVRegions()" class="map-control-btn" style="border-left: 3px solid #F6C453;">Regiones UV</button>
    `;

        function setActiveBtn(id) {
            document.querySelectorAll('.map-control-btn').forEach(b => b.classList.remove('active'));
            const btn = document.getElementById(id);
            if (btn) btn.classList.add('active');
        }


        let municipiosIndex = [];
        let municipalGeoJSON = null;


        fetch('Municipal_opt.geojson')
            .then(r => r.json())
            .then(data => {
                municipalGeoJSON = data;


                municipiosIndex = data.features.map(f => ({
                    cve: f.properties.CVEGEO,
                    nombre: f.properties.NOMGEO,
                    bounds: L.geoJSON(f).getBounds()
                }));

                mergePopulationData();


                const geoLayer = L.geoJSON(data, {
                    style: (feature) => {
                        const pob = feature.properties.POB1 || 0;
                        return {
                            fillColor: getColor(pob),
                            weight: 1,
                            opacity: 1,
                            color: 'white',
                            fillOpacity: 0.7
                        };
                    },
                    onEachFeature: (f, l) => {
                        const cve = f.properties.CVEGEO;
                        const nombre = f.properties.NOMGEO;

                        l.on('click', () => {
                            // limpiar resaltado previo
                            try { highlightLayer.clearLayers(); } catch (e) { }
                            if (highlightLabel) { try { map.removeLayer(highlightLabel); } catch (e) { }; highlightLabel = null; }


                            highlightLayer.addData(f);
                            applyGlowToLayer(highlightLayer);

                            const center = l.getBounds().getCenter();
                            highlightLabel = L.marker(center, {
                                icon: L.divIcon({
                                    className: 'etiquetaGlow',
                                    html: `<div class="labelBox pulseLabel">${nombre}</div>`
                                }),
                                interactive: false
                            }).addTo(map);


                            mostrarInfoMunicipio(cve, nombre);
                        });

                        l.bindPopup(nombre);
                    }
                });


                layers.municipios.addLayer(geoLayer);
            })
            .catch(e => console.warn("Error cargando Municipal.geojson (precarga):", e));

        function normalizar(txt) {
            if (!txt) return '';
            return txt.normalize('NFD').replace(/[\u0300-\u036f]/g, "").toLowerCase();
        }

        const input = document.getElementById('search-input');
        const results = document.getElementById('search-results');

        input.addEventListener('input', () => {
            const q = normalizar(input.value.trim());
            if (q.length < 2) { results.classList.add('hidden'); results.innerHTML = ''; return; }

            const matches = municipiosIndex.filter(m => normalizar(m.nombre).includes(q)).slice(0, 30);
            if (matches.length === 0) {
                results.innerHTML = `<li class="p-2 text-gray-500">Sin resultados</li>`;
                results.classList.remove('hidden');
                return;
            }

            results.innerHTML = matches.map(m => `<li class="p-2" data-cve="${m.cve}">${m.nombre}</li>`).join('');
            results.classList.remove('hidden');
        });


        results.addEventListener('click', e => {
            const cve = e.target.dataset.cve;
            if (!cve) return;

            const item = municipiosIndex.find(x => x.cve === cve);
            if (!item) return;


            try { highlightLayer.clearLayers(); } catch (e) { }
            if (highlightLabel) { try { map.removeLayer(highlightLabel); } catch (e) { }; highlightLabel = null; }


            let feature = null;
            if (municipalGeoJSON && municipalGeoJSON.features) {
                feature = municipalGeoJSON.features.find(f => f.properties.CVEGEO === cve);
            }


            if (feature) {
                highlightLayer.addData(feature);
                applyGlowToLayer(highlightLayer);


                const tmp = L.geoJSON(feature);
                const bounds = tmp.getBounds();


                try {
                    map.flyToBounds(bounds, { padding: [40, 40], duration: 1.0 });
                } catch (e) {
                    try { map.fitBounds(bounds, { padding: [40, 40] }); } catch (e) { }
                }


                const center = bounds.getCenter();
                highlightLabel = L.marker(center, {
                    icon: L.divIcon({
                        className: 'etiquetaGlow',
                        html: `<div class="labelBox pulseLabel">${item.nombre}</div>`
                    }),
                    interactive: false
                }).addTo(map);


                mostrarInfoMunicipio(item.cve, item.nombre);


                // Filtro de servicios removido por limpieza de c√≥digo (funcionalidad no activa en sidebar actualmente)
            } else {

                fetch('Municipal_opt.geojson').then(r => r.json()).then(data => {
                    const f = data.features.find(ff => ff.properties.CVEGEO === cve);
                    if (!f) return;
                    highlightLayer.addData(f);
                    applyGlowToLayer(highlightLayer);
                    const tmp = L.geoJSON(f);
                    try { map.flyToBounds(tmp.getBounds(), { padding: [40, 40], duration: 1.0 }); } catch (e) { }
                    highlightLabel = L.marker(tmp.getBounds().getCenter(), { icon: L.divIcon({ className: 'etiquetaGlow', html: `<div class="labelBox pulseLabel">${item.nombre}</div>` }), interactive: false }).addTo(map);
                    mostrarInfoMunicipio(item.cve, item.nombre);


                    // Filtro de servicios removido
                }).catch(err => console.warn("fallback fetch error", err));
            }


            input.value = item.nombre;
            results.classList.add('hidden');


            const clearBtn = document.getElementById('clear-search');
            if (clearBtn) clearBtn.style.display = 'block';


            try { if (!map.hasLayer(layers.municipios)) layers.municipios.addTo(map); } catch (e) { }
        });


        function clearMunicipioFilter() {
            const input = document.getElementById('search-input');
            const clearBtn = document.getElementById('clear-search');


            if (input) input.value = '';


            if (clearBtn) clearBtn.style.display = 'none';


            try { highlightLayer.clearLayers(); } catch (e) { }
            if (highlightLabel) {
                try { map.removeLayer(highlightLabel); } catch (e) { }
                highlightLabel = null;
            }


            if (currentScale === 'municipios' && servicePointsLoaded) {
                console.log('Mostrando todos los servicios (filtro removido)');
                addServicePointsToMap(allServicePoints);


                for (let i = 1; i <= 5; i++) {
                    const btn = document.getElementById(`btn-serv-${i}`);
                    if (btn && btn.classList.contains('active')) {
                        layers.servicios[i].addTo(map);
                    }
                }
            }


            try {
                map.setView([19.17, -96.13], 7);
            } catch (e) { }

            console.log('Filtro de municipio limpiado');
        }


        fetch('Nacional_opt.geojson').then(r => r.json()).then(data => {
            const l = L.geoJSON(data);
            map.fitBounds(l.getBounds(), { padding: [30, 30] });
        }).catch(e => console.warn("Error loading initial bounds", e));

        setTimeout(() => map.invalidateSize(), 800);
    </script>


    <script>
        // ============================================
        // DATOS DE POBLACI√ìN (cargados din√°micamente)
        // ============================================
        // Variable global para almacenar los datos de poblaci√≥n
        let poblacion = {
            "nacional": {},
            "veracruz": {},
            "municipios": []
        };

        // Cargar datos de poblaci√≥n desde archivo JSON externo
        fetch("poblacion_veracruz.json")
            .then(r => {
                if (!r.ok) throw new Error("poblacion_veracruz.json no encontrado");
                return r.json();
            })
            .then(data => {
                poblacion = data;
                console.log('‚úì Datos de poblaci√≥n cargados correctamente');
                mergePopulationData();
            })
            .catch(e => console.warn('Error cargando datos de poblaci√≥n:', e));


        let currentChart = null;

        const _oldMostrar = mostrarInfoMunicipio;
        mostrarInfoMunicipio = function (cve, nombre) {
            _oldMostrar(cve, nombre);

            const p = poblacion.municipios.find(x => x.NOMGEO === nombre);
            actualizarLeyenda('municipios', p);

            if (p) {
                const panel = document.getElementById('info-content');

                // Limpiar contenido previo y a√±adir estructura para el gr√°fico
                panel.innerHTML = `
                    <div class="mb-4">
                        <p class="text-xs uppercase tracking-widest text-[#F6C453] mb-1 font-bold">Demograf√≠a</p>
                        <h3 class="text-lg font-bold mb-3">${nombre}</h3>
                        
                        <div class="bg-white/10 rounded-xl p-3 mb-4 border border-white/5">
                            <p class="text-[10px] uppercase opacity-60 mb-0.5">Poblaci√≥n Total</p>
                            <p class="text-2xl font-black text-[#F6C453]">${(p.POB1 || 0).toLocaleString()}</p>
                        </div>

                        <ul class="text-[12px] space-y-2 mb-4">
                            <li class="flex justify-between items-center text-blue-300">
                                <span class="flex items-center gap-2"><div class="w-3 h-3 rounded-full bg-[#3B82F6]"></div> Hombres</span> 
                                <b class="text-white">${(p.POB84 || 0).toLocaleString()}</b>
                            </li>
                            <li class="flex justify-between items-center text-pink-300">
                                <span class="flex items-center gap-2"><div class="w-3 h-3 rounded-full bg-[#F472B6]"></div> Mujeres</span> 
                                <b class="text-white">${(p.POB42 || 0).toLocaleString()}</b>
                            </li>
                        </ul>
                        <div class="relative h-44 w-full">
                            <canvas id="poblacionChart"></canvas>
                        </div>
                    </div>
                `;

                // Destruir gr√°fico anterior si existe
                if (currentChart) {
                    currentChart.destroy();
                }

                // Esperar un poco a que el DOM se actualice para renderizar el gr√°fico
                setTimeout(() => {
                    const ctx = document.getElementById('poblacionChart').getContext('2d');
                    currentChart = new Chart(ctx, {
                        type: 'doughnut',
                        data: {
                            labels: ['Hombres', 'Mujeres'],
                            datasets: [{
                                data: [p.POB84, p.POB42],
                                backgroundColor: ['#3B82F6', '#F472B6'], // Azul para hombres, Rosa para mujeres
                                borderWidth: 0,
                                hoverOffset: 4
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    position: 'bottom',
                                    labels: {
                                        color: '#fff',
                                        font: { size: 10 },
                                        padding: 10
                                    }
                                }
                            }
                        }
                    });
                }, 100);
            }
        };


        const _oldShowState = showState;
        showState = function () {
            // L√≥gica de Toggle: Si ya estamos en esta escala, alternar el panel de informaci√≥n
            if (currentScale === 'estatal') {
                document.getElementById('info-panel').classList.toggle('hidden');
                return;
            }
            _oldShowState();
            const p = poblacion.veracruz;
            if (p) {
                const panel = document.getElementById('info-content');
                panel.innerHTML = `
                    <div class="mb-4">
                        <p class="text-xs uppercase tracking-widest text-[#F6C453] mb-1 font-bold">Estatal</p>
                        <h3 class="text-lg font-bold mb-3">Estado de Veracruz</h3>
                        
                        <div class="bg-white/10 rounded-xl p-3 mb-4 border border-white/5">
                            <p class="text-[10px] uppercase opacity-60 mb-0.5">Poblaci√≥n Total</p>
                            <p class="text-2xl font-black text-[#F6C453]">${(p.POB1 || 0).toLocaleString()}</p>
                        </div>

                        <ul class="text-[12px] space-y-2 mb-4">
                            <li class="flex justify-between items-center text-blue-300">
                                <span class="flex items-center gap-2"><div class="w-3 h-3 rounded-full bg-[#3B82F6]"></div> Hombres</span> 
                                <b class="text-white">${(p.POB84 || 0).toLocaleString()}</b>
                            </li>
                            <li class="flex justify-between items-center text-pink-300">
                                <span class="flex items-center gap-2"><div class="w-3 h-3 rounded-full bg-[#F472B6]"></div> Mujeres</span> 
                                <b class="text-white">${(p.POB42 || 0).toLocaleString()}</b>
                            </li>
                        </ul>
                        <div class="relative h-44 w-full">
                            <canvas id="poblacionChartEstatal"></canvas>
                        </div>
                    </div>
                `;

                if (currentChart) currentChart.destroy();

                setTimeout(() => {
                    const ctx = document.getElementById('poblacionChartEstatal').getContext('2d');
                    currentChart = new Chart(ctx, {
                        type: 'pie',
                        data: {
                            labels: ['Hombres', 'Mujeres'],
                            datasets: [{
                                data: [p.POB84, p.POB42],
                                backgroundColor: ['#3B82F6', '#F472B6'],
                                borderWidth: 0
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    position: 'bottom',
                                    labels: { color: '#fff', font: { size: 10 } }
                                }
                            }
                        }
                    });
                }, 100);
            }
        };


        const _oldShowNational = showNational;
        showNational = function () {
            // L√≥gica de Toggle: Si ya estamos en esta escala, alternar el panel de informaci√≥n
            if (currentScale === 'nacional') {
                document.getElementById('info-panel').classList.toggle('hidden');
                return;
            }
            _oldShowNational();
            const p = poblacion.nacional;
            if (p) {
                const panel = document.getElementById('info-content');
                panel.innerHTML = `
                    <div class="mb-4">
                        <p class="text-xs uppercase tracking-widest text-[#F6C453] mb-1 font-bold">Nacional</p>
                        <h3 class="text-lg font-bold mb-3">Nivel Nacional</h3>
                        
                        <div class="bg-white/10 rounded-xl p-3 mb-4 border border-white/5">
                            <p class="text-[10px] uppercase opacity-60 mb-0.5">Poblaci√≥n Total</p>
                            <p class="text-2xl font-black text-[#F6C453]">${(p.POB1 || 0).toLocaleString()}</p>
                        </div>

                        <ul class="text-[12px] space-y-2 mb-4">
                            <li class="flex justify-between items-center text-blue-300">
                                <span class="flex items-center gap-2"><div class="w-3 h-3 rounded-full bg-[#3B82F6]"></div> Hombres</span> 
                                <b class="text-white">${(p.POB84 || 0).toLocaleString()}</b>
                            </li>
                            <li class="flex justify-between items-center text-pink-300">
                                <span class="flex items-center gap-2"><div class="w-3 h-3 rounded-full bg-[#F472B6]"></div> Mujeres</span> 
                                <b class="text-white">${(p.POB42 || 0).toLocaleString()}</b>
                            </li>
                        </ul>
                        <div class="relative h-44 w-full">
                            <canvas id="poblacionChartNacional"></canvas>
                        </div>
                    </div>
                `;

                if (currentChart) currentChart.destroy();

                setTimeout(() => {
                    const ctx = document.getElementById('poblacionChartNacional').getContext('2d');
                    currentChart = new Chart(ctx, {
                        type: 'doughnut',
                        data: {
                            labels: ['Hombres', 'Mujeres'],
                            datasets: [{
                                data: [p.POB84, p.POB42],
                                backgroundColor: ['#3B82F6', '#F472B6'],
                                borderWidth: 0
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    position: 'bottom',
                                    labels: { color: '#fff', font: { size: 10 } }
                                }
                            }
                        }
                    });
                }, 100);
            }
        };

        // ============================================
        // CONFIGURACI√ìN DE SERVIDOR PYTHON (Nativa)
        // ============================================
        let db = null;
        let pythonServerActive = true;

        function updateCloudUI(online) {
            const statusNode = document.querySelector('.status span');
            if (statusNode) {
                statusNode.textContent = online ? 'Servidor Python Online' : 'Servidor Offline';
            }
        }

        // Variables globales para el sistema de puntos personalizados
        let markerModeActive = false;
        let customPointsLayer = L.layerGroup().addTo(map);
        let customPoints = [];
        let currentEditingPoint = null;
        let tempMarker = null;

        // Colores por categor√≠a (Sin cambios)
        const categoryColors = {
            'comercio': '#f59e0b',
            'oficina': '#3b82f6',
            'educacion': '#8b5cf6',
            'salud': '#ef4444',
            'recreacion': '#10b981',
            'transporte': '#06b6d4',
            'gobierno': '#6366f1',
            'otro': '#64748b'
        };

        const subcategoriesMap = {
            'comercio': ['Supermercado', 'Tienda Local', 'Plaza Comercial', 'Restaurante', 'Mercado', 'Farmacia', 'Oxxo/7-Eleven', 'Otro'],
            'oficina': ['Administrativa', 'Corporativa', 'Servicios', 'Consultor√≠a', 'Coworking', 'Otro'],
            'educacion': ['Preescolar', 'Primaria', 'Secundaria', 'Preparatoria', 'Universidad', 'Posgrado', 'Centro de Investigaci√≥n', 'Biblioteca', 'Otro'],
            'salud': ['Hospital General', 'Cl√≠nica Especializada', 'Centro de Salud', 'Consultorio Privado', 'Laboratorio', 'Farmacia con Consultorio', 'Otro'],
            'recreacion': ['Parque', 'Cancha Deportiva', 'Gimnasio', 'Cine', 'Museo/Cultura', 'Centro Comunitario', '√Årea Natural', 'Otro'],
            'transporte': ['Estaci√≥n de Autob√∫s', 'Terminal', 'Parada de Taxi', 'Gasolinera', 'Taller Mec√°nico', 'Estacionamiento', 'Otro'],
            'gobierno': ['Palacio Municipal', 'Delegaci√≥n', 'Oficina Estatal', 'Oficina Federal', 'Centro de Atenci√≥n', 'Seguridad/Polic√≠a', 'Otro'],
            'otro': ['Residencial', 'Terreno Bald√≠o', 'Monumento', 'Religioso', 'Industrial', 'Infraestructura', 'Otro']
        };

        function updateSubcategories(selectedSub = '') {
            const category = document.getElementById('point-category').value;
            const subDropdown = document.getElementById('point-subcategory');
            subDropdown.innerHTML = '<option value="">Selecciona una subcategor√≠a</option>';
            if (category && subcategoriesMap[category]) {
                subDropdown.disabled = false;
                subcategoriesMap[category].forEach(sub => {
                    const option = document.createElement('option');
                    option.value = sub.toLowerCase();
                    option.textContent = sub;
                    if (sub.toLowerCase() === selectedSub.toLowerCase()) option.selected = true;
                    subDropdown.appendChild(option);
                });
            } else {
                subDropdown.disabled = true;
                subDropdown.innerHTML = '<option value="">Primero selecciona una categor√≠a</option>';
            }
        }

        function toDMS(dd, isLat) {
            const absDd = Math.abs(dd);
            const deg = Math.floor(absDd);
            const min = Math.floor((absDd - deg) * 60);
            const sec = ((absDd - deg - min / 60) * 3600).toFixed(2);
            let dir = isLat ? (dd >= 0 ? "N" : "S") : (dd >= 0 ? "E" : "W");
            return `${deg}¬∞ ${min}' ${sec}" ${dir}`;
        }

        function toUTM(lat, lon) {
            const zone = Math.floor((lon + 180) / 6) + 1;
            const letter = lat > 0 ? 'Q' : 'K';
            return `Zona ${zone}${letter} | Lat: ${lat.toFixed(4)}, Lon: ${lon.toFixed(4)}`;
        }

        async function fetchReverseGeocode(lat, lng) {
            const addrInput = document.getElementById('point-address');
            addrInput.value = "Obteniendo direcci√≥n...";
            try {
                const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${lat}&lon=${lng}`, {
                    headers: { 'User-Agent': 'MapaInteractivaUV/1.0' }
                });
                const data = await response.json();
                addrInput.value = (data && data.display_name) ? data.display_name : "Direcci√≥n no encontrada";
            } catch (error) {
                addrInput.value = "";
            }
        }

        // ============================================
        // FUNCIONES DE SERVIDOR PYTHON (API)
        // ============================================

        async function loadCustomPointsFromServer() {
            try {
                const response = await apiFetch('/api/v1/points');
                customPoints = await response.json();
                renderCustomPoints();
                updateSavedPointsList();
                updateCloudUI(true);
            } catch (error) {
                console.error('‚ùå Error cargando desde el servidor:', error);
                updateCloudUI(false);
            }
        }

        async function savePointToServer(pointData) {
            try {
                const response = await fetchWithAuth('/api/v1/points', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(pointData)
                });
                return response.ok;
            } catch (error) {
                console.error('‚ùå Error guardando en el servidor:', error);
                return false;
            }
        }

        async function deletePointFromServer(pointId) {
            try {
                // Si pointId es un objeto (evento), extraer el id real
                const id = (typeof pointId === 'object') ? pointId.id : pointId;
                const response = await fetchWithAuth(`/api/v1/points/${id}`, {
                    method: 'DELETE'
                });
                return response.ok;
            } catch (error) {
                console.error('‚ùå Error eliminando del servidor:', error);
                return false;
            }
        }
        function toggleMarkerMode() {
            markerModeActive = !markerModeActive;
            const btn = document.getElementById('marker-mode-toggle');
            if (markerModeActive) {
                // Limpiar cualquier resaltado de municipio o pol√≠gono nacional que estorbe la visual
                try { highlightLayer.clearLayers(); } catch (e) { }
                if (highlightLabel) { try { map.removeLayer(highlightLabel); } catch (e) { }; highlightLabel = null; }

                // Si la capa de municipios est√° activa, bajamos su opacidad para que no estorbe la selecci√≥n del punto
                if (map.hasLayer(layers.municipios)) {
                    layers.municipios.setStyle({ fillOpacity: 0.05, weight: 0.5 });
                }

                // Cerrar cualquier popup abierto para limpiar la vista
                map.closePopup();

                btn.classList.add('active');
                btn.querySelector('span').textContent = 'Modo Activo - Haz clic en el mapa';
                map.getContainer().style.cursor = 'crosshair';
                map.on('click', onMapClickForMarker);
            } else {
                // Restaurar estilo normal al desactivar
                if (map.hasLayer(layers.municipios)) {
                    layers.municipios.setStyle({ fillOpacity: 0.18, weight: 1 });
                }

                btn.classList.remove('active');
                btn.querySelector('span').textContent = 'Marcar Puntos Personalizados';
                map.getContainer().style.cursor = '';
                map.off('click', onMapClickForMarker);
                if (tempMarker) { map.removeLayer(tempMarker); tempMarker = null; }
            }
        }

        function onMapClickForMarker(e) {
            const { lat, lng } = e.latlng;
            if (tempMarker) map.removeLayer(tempMarker);
            tempMarker = L.marker([lat, lng], {
                icon: L.divIcon({
                    className: 'temp-marker-container',
                    html: `<div class="temp-marker" style="background: #F6C453; width: 30px; height: 30px; border-radius: 50% 50% 50% 0; transform: rotate(-45deg); border: 3px solid white; box-shadow: 0 4px 10px rgba(0,0,0,0.3);"></div>`,
                    iconSize: [30, 30],
                    iconAnchor: [15, 42]
                })
            }).addTo(map);
            openMarkerPanel(lat, lng);
        }

        function openMarkerPanel(lat, lng, existingPoint = null) {
            const panel = document.getElementById('point-marker-panel');
            panel.classList.add('active');
            document.getElementById('point-lat').value = lat.toFixed(6);
            document.getElementById('point-lng').value = lng.toFixed(6);
            document.getElementById('coord-dms').textContent = `DMS: ${toDMS(lat, true)} | ${toDMS(lng, false)}`;
            document.getElementById('coord-utm').textContent = `UTM: ${toUTM(lat, lng)}`;

            if (existingPoint) {
                currentEditingPoint = existingPoint;
                document.getElementById('point-name').value = existingPoint.name;
                document.getElementById('point-category').value = existingPoint.category;
                updateSubcategories(existingPoint.subcategory || '');
                document.getElementById('point-description').value = existingPoint.description || '';
                document.getElementById('point-address').value = existingPoint.address || '';
                document.getElementById('point-image').value = existingPoint.image_url || '';
                document.getElementById('delete-button-container').style.display = 'block';
                panel.querySelector('h2').innerHTML = '<i class="fas fa-edit"></i> Editar Punto';
            } else {
                currentEditingPoint = null;
                document.getElementById('point-form').reset();
                document.getElementById('point-lat').value = lat.toFixed(6);
                document.getElementById('point-lng').value = lng.toFixed(6);
                document.getElementById('delete-button-container').style.display = 'none';
                panel.querySelector('h2').innerHTML = '<i class="fas fa-map-pin"></i> Punto Personalizado';
                fetchReverseGeocode(lat, lng);
            }
        }

        function closeMarkerPanel() {
            document.getElementById('point-marker-panel').classList.remove('active');
            document.getElementById('point-form').reset();
            currentEditingPoint = null;
            if (tempMarker) { map.removeLayer(tempMarker); tempMarker = null; }
        }

        async function saveCustomPoint(event) {
            event.preventDefault();
            const pointData = {
                name: document.getElementById('point-name').value,
                category: document.getElementById('point-category').value,
                subcategory: document.getElementById('point-subcategory').value,
                description: document.getElementById('point-description').value,
                address: document.getElementById('point-address').value,
                lat: parseFloat(document.getElementById('point-lat').value),
                lng: parseFloat(document.getElementById('point-lng').value),
                image_url: document.getElementById('point-image').value
            };

            const success = await savePointToServer(pointData);
            if (success) {
                showNotification('Punto guardado en tu servidor Python üöÄ', 'success');
                await loadCustomPointsFromServer();
                closeMarkerPanel();
            } else {
                showNotification('Error al guardar en el servidor.', 'error');
            }
        }

        function renderCustomPoints(pointsToRender = customPoints) {
            customPointsLayer.clearLayers();
            pointsToRender.forEach(point => {
                const color = categoryColors[point.category] || '#64748b';
                const marker = L.marker([point.lat, point.lng], {
                    icon: L.divIcon({
                        className: 'custom-point-marker',
                        html: `<div style="background: ${color}; width: 24px; height: 24px; border-radius: 50% 50% 50% 0; transform: rotate(-45deg); border: 2px solid white; box-shadow: 0 3px 8px rgba(0,0,0,0.4); display: flex; align-items: center; justify-content: center;"><i class="fas fa-star" style="color: white; font-size: 10px; transform: rotate(45deg);"></i></div>`,
                        iconSize: [24, 24],
                        iconAnchor: [14, 30]
                    })
                });

                const userRole = localStorage.getItem('sig_role');
                const container = document.createElement('div');
                container.style.minWidth = "250px";
                container.innerHTML = `
                    <h3 style="color: ${color}; font-weight: bold; margin-bottom: 8px; font-size: 15px; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom:4px;">${point.name}</h3>
                    <div style="font-size: 12px; color: rgba(255,255,255,0.9);">
                        ${point.image_url ? `<img src="${getFullUrl(point.image_url)}" class="w-full h-32 object-cover rounded-lg mb-3 border border-white/20 shadow-lg cursor-pointer" onclick="window.open('${getFullUrl(point.image_url)}', '_blank')">` : ''}
                        <p><strong>Categor√≠a:</strong> ${getCategoryLabel(point.category)}</p>
                        ${point.address ? `<p><strong>Direcci√≥n:</strong> ${point.address}</p>` : ''}
                        
                        
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 12px; padding: 8px 0; border-top: 1px solid rgba(255,255,255,0.1);">
                            <button onclick="likePoint(${point.id}, this)" class="social-btn ${localStorage.getItem('liked_' + point.id) ? 'liked' : ''}">
                                <i class="fas fa-heart"></i> <span class="like-count">${point.likes || 0}</span>
                            </button>
                            <button onclick="toggleComments(${point.id})" class="social-btn">
                                <i class="fas fa-comment"></i> Comentarios
                            </button>
                        </div>

                        <div id="comments-section-${point.id}" class="hidden" style="margin-top:10px;">
                            <div id="comments-list-${point.id}" style="max-height: 120px; overflow-y: auto; font-size: 10px; background: rgba(0,0,0,0.2); border-radius: 8px; padding: 6px;">
                                <p style="opacity: 0.5; text-align: center;">Cargando comentarios...</p>
                            </div>
                            <div style="display: flex; gap: 4px; margin-top: 6px;">
                                <input type="text" id="comment-input-${point.id}" placeholder="Escribe un comentario..." style="flex:1; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 4px; padding: 4px; color: white; font-size: 10px;">
                                <button onclick="sendComment(${point.id})" style="background: #F6C453; color: #1e3c72; border: none; padding: 4px 8px; border-radius: 4px; font-size: 10px; font-weight: bold;">‚û°Ô∏è</button>
                            </div>
                        </div>

                        <div style="display: flex; gap: 8px; margin-top: 12px;">
                            ${(authToken && userRole === 'admin') ? `
                            <button onclick="editCustomPoint(${point.id})" style="flex:1; padding:4px; border-radius:4px; background:#F6C453; color:#1e3c72; border:none; cursor:pointer; font-weight:600; font-size: 11px;">Editar</button>
                            <button onclick="window.deleteCustomPoint(${point.id})" style="flex:1; padding:4px; border-radius:4px; background:#ef4444; color:white; border:none; cursor:pointer; font-weight:600; font-size: 11px;">Borrar</button>
                            ` : (authToken ? '<p style="font-size:10px; opacity:0.6; text-align:center; width:100%;">Solo el administrador puede editar o borrar</p>' : '<p style="font-size:10px; opacity:0.6; text-align:center; width:100%;">Inicia sesi√≥n para interactuar</p>')}
                        </div>
                    </div>
                `;
                marker.bindPopup(container);
                customPointsLayer.addLayer(marker);
            });
        }

        function setupCategoryFilters() {
            const container = document.getElementById('category-checkboxes');
            container.innerHTML = `
                <div class="flex gap-2 mb-2">
                    <button onclick="toggleAllCategories(true)" class="text-[9px] px-2 py-1 bg-white/10 hover:bg-white/20 rounded border border-white/10 text-white/70">Todos</button>
                    <button onclick="toggleAllCategories(false)" class="text-[9px] px-2 py-1 bg-white/10 hover:bg-white/20 rounded border border-white/10 text-white/70">Ninguno</button>
                </div>
            `;

            Object.keys(categoryColors).forEach(cat => {
                const label = getCategoryLabel(cat);
                const color = categoryColors[cat];
                const div = document.createElement('div');
                div.className = 'flex items-center gap-2 text-[11px] mb-1';
                div.innerHTML = `
                    <input type="checkbox" id="filter-${cat}" checked onchange="filterCustomPoints()" class="w-3 h-3 accent-[#F6C453]">
                    <span style="width:8px; height:8px; background:${color}; border-radius:50%;"></span>
                    <label for="filter-${cat}" class="cursor-pointer opacity-90">${label}</label>
                `;
                container.appendChild(div);
            });
        }

        function toggleAllCategories(checked) {
            Object.keys(categoryColors).forEach(cat => {
                const cb = document.getElementById(`filter-${cat}`);
                if (cb) cb.checked = checked;
            });
            filterCustomPoints();
        }

        function filterCustomPoints() {
            const query = document.getElementById('point-search-input').value.toLowerCase();

            // Obtener categor√≠as seleccionadas
            const activeCategories = Object.keys(categoryColors).filter(cat => {
                const cb = document.getElementById(`filter-${cat}`);
                return cb ? cb.checked : true;
            });

            const filtered = customPoints.filter(p => {
                const matchesSearch = p.name.toLowerCase().includes(query) ||
                    (p.description && p.description.toLowerCase().includes(query));
                const matchesCategory = activeCategories.includes(p.category);
                return matchesSearch && matchesCategory;
            });

            renderCustomPoints(filtered);

            // Si solo hay un resultado, hacer zoom autom√°tico
            if (filtered.length === 1 && query.length > 3) {
                map.setView([filtered[0].lat, filtered[0].lng], 16);
            }
        }

        window.deleteCustomPoint = async function (pointId) {
            const point = customPoints.find(p => String(p.id) === String(pointId));
            if (!point) return;
            if (await showCustomConfirm(`¬øEliminar "${point.name}" de tu base de datos ? `)) {
                const success = await deletePointFromServer(pointId);
                if (success) {
                    showNotification('Punto eliminado del servidor', 'success');
                    await loadCustomPointsFromServer();
                    if (currentEditingPoint && String(currentEditingPoint.id) === String(pointId)) closeMarkerPanel();
                } else {
                    showNotification('Error al eliminar del servidor', 'error');
                }
            }
        };

        async function likePoint(id, btn) {
            if (!authToken) { showNotification('Inicia sesi√≥n para dar Like ‚ù§Ô∏è', 'info'); return; }
            if (localStorage.getItem('liked_' + id)) { showNotification('Ya te gusta este punto.', 'info'); return; }

            try {
                const res = await fetchWithAuth(`/api/v1/points/${id}/like`, { method: 'POST' });
                if (res.ok) {
                    const countSpan = btn.querySelector('.like-count');
                    countSpan.textContent = parseInt(countSpan.textContent) + 1;
                    btn.classList.add('liked');
                    localStorage.setItem('liked_' + id, 'true');
                    showNotification('¬°Te gusta este punto!', 'success');
                }
            } catch (e) { console.error(e); }
        }

        async function toggleComments(id) {
            const section = document.getElementById(`comments-section-${id}`);
            section.classList.toggle('hidden');
            if (!section.classList.contains('hidden')) {
                loadComments(id);
            }
        }

        async function loadComments(id) {
            const list = document.getElementById(`comments-list-${id}`);
            try {
                const res = await apiFetch(`/api/v1/points/${id}/comments`);
                const data = await res.json();
                if (data.length === 0) {
                    list.innerHTML = '<p style="opacity:0.4; text-align:center; padding:10px;">Sin comentarios a√∫n.</p>';
                    return;
                }
                list.innerHTML = data.map(c => `
                    <div class="comment-item" style="margin-bottom:6px; background:rgba(255,255,255,0.05); padding:6px; border-radius:5px;">
                        <b style="color:#F6C453; font-size:9px;">${c.user_name}:</b>
                        <span style="font-size:10px;">${c.content}</span>
                        <div style="font-size:8px; opacity:0.4; margin-top:2px;">${new Date(c.timestamp).toLocaleString()}</div>
                    </div>
                `).join('');
            } catch (e) { list.innerHTML = 'Error al cargar.'; }
        }

        async function sendComment(id) {
            if (!authToken) { showNotification('Inicia sesi√≥n para comentar üí¨', 'info'); return; }
            const input = document.getElementById(`comment-input-${id}`);
            const content = input.value.trim();
            if (!content) return;

            try {
                const res = await fetchWithAuth(`/api/v1/points/${id}/comments`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ content })
                });
                if (res.ok) {
                    input.value = '';
                    loadComments(id);
                    showNotification('Comentario enviado.', 'success');
                }
            } catch (e) { showNotification('Error al enviar comentario.', 'error'); }
        }

        async function handleFileUpload(input) {
            if (!input.files || !input.files[0]) return;
            const status = document.getElementById('upload-status');
            status.textContent = 'Subiendo imagen...';
            status.style.color = '#F6C453';

            const formData = new FormData();
            formData.append('file', input.files[0]);

            try {
                const res = await fetchWithAuth('/api/v1/upload', {
                    method: 'POST',
                    body: formData
                });
                if (res.ok) {
                    const data = await res.json();
                    document.getElementById('point-image').value = data.url;
                    status.textContent = '‚úÖ Subida con √©xito';
                    status.style.color = '#10b981';
                    showNotification('Imagen cargada correctamente.', 'success');
                } else {
                    status.textContent = '‚ùå Error al subir';
                    status.style.color = '#ef4444';
                }
            } catch (e) {
                status.textContent = '‚ùå Error de conexi√≥n';
                status.style.color = '#ef4444';
            }
        }

        function editCustomPoint(pointId) {
            const point = customPoints.find(p => String(p.id) === String(pointId));
            if (point) openMarkerPanel(point.lat, point.lng, point);
        }

        function getCategoryLabel(cat) {
            const labels = {
                'comercio': 'üè™ Comercio',
                'oficina': 'üè¢ Oficina',
                'educacion': 'üéì Educaci√≥n',
                'salud': 'üè• Salud',
                'recreacion': 'üéØ Recreaci√≥n',
                'transporte': 'üöå Transporte',
                'gobierno': 'üèõÔ∏è Gobierno',
                'otro': 'üìç Otro'
            };
            return labels[cat] || cat;
        }

        function updateSavedPointsList() {
            const list = document.getElementById('saved-points-list');
            document.getElementById('saved-points-count').textContent = customPoints.length;
            if (customPoints.length === 0) {
                list.innerHTML = '<p style="text-align:center; opacity:0.5;">No hay puntos</p>';
                return;
            }
            list.innerHTML = customPoints.map(p => `
                <div class="saved-point-item" onclick="focusOnPoint(${p.id})">
                    <h4>${p.name}</h4>
                    <p>${getCategoryLabel(p.category)}</p>
                </div>
            `).join('');
        }

        function focusOnPoint(id) {
            const p = customPoints.find(x => x.id === id);
            if (p) { map.setView([p.lat, p.lng], 16); }
        }

        // Sistema de Notificaciones Reales (Toast)
        function showNotification(message, type = 'info') {
            console.log(`[SIG] ${type}: ${message}`);

            let container = document.getElementById('notification-toast-container');
            if (!container) {
                container = document.createElement('div');
                container.id = 'notification-toast-container';
                container.className = 'fixed bottom-5 right-5 z-[9999] flex flex-col gap-3 pointer-events-none';
                document.body.appendChild(container);
            }

            const toast = document.createElement('div');
            const colors = {
                success: 'from-[#00c853] to-[#b2ff59] border-[#b2ff59]',
                error: 'from-[#ff1744] to-[#f44336] border-[#ff1744]',
                info: 'from-[#1e3c72] to-[#2a5298] border-[#2a5298]'
            };

            toast.className = `p-4 rounded-2xl shadow-2xl border-l-4 bg-gradient-to-r ${colors[type] || colors.info} 
                              text-white font-bold text-sm min-w-[300px] flex items-center gap-3
                              animate-slide-in-right backdrop-blur-md bg-opacity-90 pointer-events-auto`;

            const icon = type === 'success' ? 'fa-check-circle' : (type === 'error' ? 'fa-exclamation-triangle' : 'fa-info-circle');
            toast.innerHTML = `<i class="fas ${icon} text-xl"></i> <span>${message}</span>`;

            container.appendChild(toast);

            setTimeout(() => {
                toast.classList.add('animate-slide-out-right');
                setTimeout(() => toast.remove(), 500);
            }, 4000);
        }

        // ============================================
        // SISTEMA DE AUTENTICACI√ìN Y SESI√ìN
        // ============================================
        let authToken = localStorage.getItem('sig_token') || null;
        let currentUser = localStorage.getItem('sig_user') || null;

        function openLoginModal() {
            document.getElementById('login-modal').style.display = 'flex';
        }

        function closeLoginModal() {
            document.getElementById('login-modal').style.display = 'none';
        }

        async function login(username, password) {
            try {
                const formData = new FormData();
                formData.append('username', username);
                formData.append('password', password);

                console.log('üöÄ Intentando login para:', username);
                const response = await apiFetch('/api/v1/auth/login', {
                    method: 'POST',
                    body: formData
                });

                if (response.ok) {
                    const data = await response.json();
                    authToken = data.access_token;

                    // Ahora guardamos el nombre completo si existe
                    currentUser = (data.user && data.user.full_name) ? data.user.full_name : username;
                    const role = (data.user && data.user.role) ? data.user.role : 'user';

                    localStorage.setItem('sig_token', authToken);
                    localStorage.setItem('sig_user', currentUser);
                    localStorage.setItem('sig_role', role);

                    console.log('‚úÖ Login exitoso:', currentUser);

                    // IMPORTANTE: Primero cerramos la ventana para que el usuario no sienta que se trab√≥
                    closeLoginModal();

                    try {
                        updateAuthUI();
                        showNotification(`¬°Hola, ${currentUser}! Bienvenido al SIG.`, 'success');
                        loadCustomPointsFromServer();
                    } catch (err) {
                        console.error('‚ö†Ô∏è Error visual:', err);
                    }
                } else {
                    const error = await response.json();
                    showNotification(error.detail || 'Credenciales incorrectas', 'error');
                }
            } catch (e) {
                console.error('‚ùå Error en login:', e);
                showNotification('Error de conexi√≥n con el servidor', 'error');
            }
        }

        function logout() {
            authToken = null;
            currentUser = null;
            localStorage.removeItem('sig_token');
            localStorage.removeItem('sig_user');
            localStorage.removeItem('sig_role');
            localStorage.removeItem('sig_picture');
            updateAuthUI();
            showNotification('Sesi√≥n cerrada', 'info');
        }

        function updateAuthUI() {
            try {
                const loginBtn = document.getElementById('login-btn');
                const loggedInView = document.getElementById('user-logged-in');

                if (authToken) {
                    if (loginBtn) loginBtn.classList.add('hidden');
                    if (loggedInView) {
                        loggedInView.classList.remove('hidden');
                        loggedInView.style.display = 'flex';

                        const pic = localStorage.getItem('sig_picture');
                        const displayName = currentUser || localStorage.getItem('sig_user') || 'Usuario';

                        loggedInView.innerHTML = pic ? `
                            <img src="${pic}" class="h-8 w-8 rounded-full border-2 border-[#F6C453] shadow-sm">
                            <span class="text-[10px] md:text-xs font-bold text-[#F6C453]">${displayName}</span>
                            <button onclick="logout()" class="text-white hover:text-red-400 text-[10px] md:text-xs underline p-1">Salir</button>
                        ` : `
                            <i class="fas fa-user-circle text-[#F6C453] text-lg"></i>
                            <span class="text-[10px] md:text-xs font-bold text-[#F6C453]">${displayName}</span>
                            <button onclick="logout()" class="text-white hover:text-red-400 text-[10px] md:text-xs underline p-1">Salir</button>
                        `;
                    }

                    // Mostrar bot√≥n de admin si el rol es privilegiado
                    const adminBtn = document.getElementById('admin-panel-btn');
                    const userRole = localStorage.getItem('sig_role');
                    if (adminBtn) {
                        if (userRole === 'admin') adminBtn.classList.remove('hidden');
                        else adminBtn.classList.add('hidden');
                    }
                } else {
                    if (loginBtn) loginBtn.classList.remove('hidden');
                    if (loggedInView) {
                        loggedInView.classList.add('hidden');
                        loggedInView.style.display = 'none';
                    }
                    const adminBtn = document.getElementById('admin-panel-btn');
                    if (adminBtn) adminBtn.classList.add('hidden');
                }
            } catch (err) {
                console.error('‚ùå Error en updateAuthUI:', err);
            }
        }

        // --- FUNCIONES DEL PANEL DE ADMINISTRACI√ìN ---
        function openAdminTable() {
            document.getElementById('admin-modal').classList.remove('hidden');
            fillAdminTable(customPoints);
        }

        function closeAdminTable() {
            document.getElementById('admin-modal').classList.add('hidden');
        }

        function fillAdminTable(data) {
            const tbody = document.getElementById('admin-table-body');
            const count = document.getElementById('admin-count');
            tbody.innerHTML = '';
            count.textContent = data.length;

            data.forEach(p => {
                const tr = document.createElement('tr');
                tr.className = "hover:bg-white/5 transition-colors group";
                tr.innerHTML = `
                    <td class="p-4 text-white/40 font-mono text-xs">${p.id}</td>
                    <td class="p-4">
                        <div class="font-bold text-white">${p.name}</div>
                        <div class="text-[10px] text-white/40 truncate max-w-[200px]">${p.description || 'Sin descripci√≥n'}</div>
                    </td>
                    <td class="p-4">
                        <span class="px-2 py-1 rounded-md text-[10px] uppercase font-bold" 
                              style="background: ${categoryColors[p.category]}20; color: ${categoryColors[p.category]}">
                            ${getCategoryLabel(p.category)}
                        </span>
                    </td>
                    <td class="p-4">
                        <div class="text-xs text-white/80">${p.address || 'Sin direcci√≥n'}</div>
                        <div class="text-[9px] text-white/30">${p.lat.toFixed(4)}, ${p.lng.toFixed(4)}</div>
                    </td>
                    <td class="p-4">
                        <div class="flex gap-2">
                            <button onclick="zoomToPoint(${p.id})" class="p-2 bg-blue-500/20 text-blue-400 rounded-lg hover:bg-blue-500 hover:text-white transition-all" title="Ver en mapa">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button onclick="editCustomPoint(${p.id}); closeAdminTable();" class="p-2 bg-yellow-500/20 text-yellow-400 rounded-lg hover:bg-yellow-500 hover:text-[#1e3c72] transition-all" title="Editar">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button onclick="deleteCustomPoint(${p.id})" class="p-2 bg-red-500/20 text-red-400 rounded-lg hover:bg-red-500 hover:text-white transition-all" title="Eliminar">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        function filterAdminTable() {
            const query = document.getElementById('admin-search').value.toLowerCase();
            const filtered = customPoints.filter(p =>
                p.name.toLowerCase().includes(query) ||
                p.category.toLowerCase().includes(query) ||
                (p.description && p.description.toLowerCase().includes(query)) ||
                (p.address && p.address.toLowerCase().includes(query))
            );
            fillAdminTable(filtered);
        }

        function zoomToPoint(id) {
            const p = customPoints.find(p => p.id === id);
            if (p) {
                map.setView([p.lat, p.lng], 16);
                closeAdminTable();
                // Buscar el marcador en la capa y abrir su popup
                customPointsLayer.eachLayer(layer => {
                    if (layer.getLatLng && layer.getLatLng().lat === p.lat && layer.getLatLng().lng === p.lng) {
                        layer.openPopup();
                    }
                });
            }
        }

        // Interceptor de fetch para a√±adir token
        async function fetchWithAuth(url, options = {}) {
            if (authToken) {
                options.headers = {
                    ...options.headers,
                    'Authorization': `Bearer ${authToken}`
                };
            }
            const response = await apiFetch(url, options);
            if (response.status === 401) {
                logout();
                openLoginModal();
                throw new Error('Sesi√≥n expirada');
            }
            return response;
        }

        let authMode = 'login';

        function setAuthMode(mode) {
            authMode = mode;
            const title = document.getElementById('auth-title');
            const submitBtn = document.getElementById('auth-submit-btn');
            const tabLogin = document.getElementById('tab-login');
            const tabRegister = document.getElementById('tab-register');
            const regFields = document.getElementById('register-only-fields');

            if (mode === 'login') {
                title.textContent = 'Acceso Administrativo';
                submitBtn.textContent = 'INGRESAR AL SIG';
                tabLogin.className = 'flex-1 py-3 font-bold text-[#F6C453] border-b-2 border-[#F6C453] bg-white/5';
                tabRegister.className = 'flex-1 py-3 font-bold text-white/40 border-b-2 border-transparent';
                regFields.classList.add('hidden');
            } else {
                title.textContent = 'Crear Perfil SIG';
                submitBtn.textContent = 'COMPLETAR REGISTRO';
                tabLogin.className = 'flex-1 py-3 font-bold text-white/40 border-b-2 border-transparent';
                tabRegister.className = 'flex-1 py-3 font-bold text-[#F6C453] border-b-2 border-[#F6C453] bg-white/5';
                regFields.classList.remove('hidden');
            }
        }

        async function handleAuth(event) {
            if (event) {
                if (event.preventDefault) event.preventDefault();
                if (event.stopPropagation) event.stopPropagation();
            }

            const btn = document.getElementById('auth-submit-btn');
            const u = document.getElementById('auth-user');
            const p = document.getElementById('auth-pass');

            if (!u || !p) return console.error('Campos no encontrados');

            if (authMode === 'login') {
                if (btn) {
                    btn.textContent = 'VALIDANDO...';
                    btn.disabled = true;
                }

                try {
                    await login(u.value, p.value);
                } catch (e) {
                    console.error('Login Error:', e);
                    showNotification('Error de sistema', 'error');
                } finally {
                    if (btn) {
                        btn.textContent = 'INGRESAR AL SIG';
                        btn.disabled = false;
                    }
                }
            } else {
                const fn = document.getElementById('reg-fullname').value;
                const em = document.getElementById('reg-email').value;
                const un = document.getElementById('reg-uni').value;
                await register(u.value, p.value, fn, em, un);
            }
        }
        window.handleAuth = handleAuth;

        async function handleGoogleLogin(response) {
            try {
                const res = await apiFetch('/api/v1/auth/google', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ token: response.credential })
                });
                if (res.ok) {
                    const data = await res.json();
                    authToken = data.access_token;
                    currentUser = data.user.full_name;
                    const picture = data.user.picture || null;

                    localStorage.setItem('sig_token', authToken);
                    localStorage.setItem('sig_user', currentUser);
                    localStorage.setItem('sig_role', data.user.role || 'user');
                    if (picture) localStorage.setItem('sig_picture', picture);

                    updateAuthUI();
                    closeLoginModal();
                    showNotification(`¬°Bienvenido, ${currentUser}! (Google)`, 'success');
                    loadCustomPointsFromServer();
                } else {
                    const errorData = await res.json();
                    showNotification(errorData.detail || 'Error al validar cuenta de Google', 'error');
                }
            } catch (e) {
                showNotification('Error de conexi√≥n con Google', 'error');
            }
        }

        // Funci√≥n para inicializar Google (se llamar√° desde el onload principal)
        function initGoogleAuth() {
            if (typeof google !== 'undefined') {
                google.accounts.id.initialize({
                    client_id: "481357191308-c06t135ahrb8nnk1vq6nfo0bcqn33cdl.apps.googleusercontent.com",
                    callback: handleGoogleLogin,
                    auto_select: false // Evita que seleccione autom√°ticamente la cuenta activa
                });
                google.accounts.id.renderButton(
                    document.getElementById("google-btn"),
                    {
                        theme: "outline",
                        size: "large",
                        text: "signin_with",
                        shape: "rectangular",
                        locale: "es",
                        logo_alignment: "left",
                        width: "320"
                    }
                );
            }
        }

        async function register(username, password, full_name, email, university) {
            try {
                const response = await apiFetch('/api/v1/auth/register', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password, full_name, email, university })
                });

                if (response.ok) {
                    showNotification('¬°Cuenta creada! Ahora inicia sesi√≥n.', 'success');
                    setAuthMode('login');
                } else {
                    const error = await response.json();
                    showNotification(error.detail || 'Error al registrar', 'error');
                }
            } catch (e) {
                showNotification('Error de conexi√≥n', 'error');
            }
        }

        window.onload = function () {
            const authForm = document.getElementById('auth-form');
            if (authForm) authForm.onsubmit = handleAuth;
            updateAuthUI();
            setupCategoryFilters();
            loadCustomPointsFromServer();
            initGoogleAuth(); // Inicializar Google aqu√≠
        };
    </script>

    <!-- Modal de Login / Registro -->
    <div id="login-modal">
        <div class="login-card">
            <!-- Bot√≥n de cierre X superior -->
            <button onclick="closeLoginModal()" class="login-close-x" title="Cerrar">
                <i class="fas fa-times"></i>
            </button>

            <!-- Selector de modo (Fijo arriba) -->
            <div class="flex border-b border-white/10 overflow-hidden shrink-0">
                <button onclick="setAuthMode('login')" id="tab-login"
                    class="flex-1 py-4 font-bold text-[#F6C453] border-b-2 border-[#F6C453] bg-white/5 transition-all">INICIAR
                    SESI√ìN</button>
                <button onclick="setAuthMode('register')" id="tab-register"
                    class="flex-1 py-4 font-bold text-white/40 border-b-2 border-transparent hover:text-white transition-all">REGISTRARSE</button>
            </div>

            <!-- √Årea con Scroll -->
            <div class="login-scroll-area text-center pt-8">
                <h2 id="auth-title" class="text-2xl font-black text-white mb-8 uppercase tracking-wider">Acceso
                    Administrativo</h2>

                <form id="auth-form" class="space-y-4">
                    <div id="register-only-fields" class="hidden space-y-4 mb-4">
                        <div class="relative">
                            <i class="fas fa-user-tag absolute left-3 top-1/2 -translate-y-1/2 text-[#F6C453]/60"></i>
                            <input type="text" id="reg-fullname" placeholder="Nombre Completo" class="login-input pl-10"
                                style="margin-bottom:0">
                        </div>
                        <div class="relative">
                            <i class="fas fa-envelope absolute left-3 top-1/2 -translate-y-1/2 text-[#F6C453]/60"></i>
                            <input type="email" id="reg-email" placeholder="Correo electr√≥nico"
                                class="login-input pl-10" style="margin-bottom:0">
                        </div>
                        <div class="relative">
                            <i
                                class="fas fa-graduation-cap absolute left-3 top-1/2 -translate-y-1/2 text-[#F6C453]/60"></i>
                            <input type="text" id="reg-uni" placeholder="Facultad" class="login-input pl-10"
                                style="margin-bottom:0">
                        </div>
                        <div class="h-px bg-white/10 my-6"></div>
                    </div>

                    <div class="relative">
                        <i class="fas fa-user absolute left-3 top-1/2 -translate-y-1/2 text-[#F6C453]/60"></i>
                        <input type="text" id="auth-user" placeholder="Usuario" class="login-input pl-10" required
                            autocomplete="username" style="margin-bottom:0">
                    </div>
                    <div class="relative">
                        <i class="fas fa-lock absolute left-3 top-1/2 -translate-y-1/2 text-[#F6C453]/60"></i>
                        <input type="password" id="auth-pass" placeholder="Contrase√±a" class="login-input pl-10"
                            required autocomplete="current-password" style="margin-bottom:0">
                    </div>

                    <div class="pt-4">
                        <button type="button" id="auth-submit-btn" onclick="handleAuth(event)"
                            class="login-submit shadow-xl hover:shadow-[#F6C453]/30">INGRESAR AL SIG</button>
                    </div>
                </form>

                <!-- Divisor para Google -->
                <div id="google-login-section">
                    <div class="flex items-center gap-3 my-8">
                        <div class="h-px bg-white/10 flex-1"></div>
                        <span class="text-[10px] font-bold text-white/30 tracking-widest uppercase">O continuar
                            con</span>
                        <div class="h-px bg-white/10 flex-1"></div>
                    </div>

                    <div class="flex justify-center">
                        <div id="google-btn"></div>
                    </div>
                </div>

                <p class="mt-8 text-[10px] text-white/30">
                    ¬© 2026 Universidad Veracruzana - SIG Web
                </p>
            </div>
        </div>
    </div>

    <!-- Panel de Administraci√≥n (Tabla Gesti√≥n) -->
    <div id="admin-modal"
        class="fixed inset-0 bg-black/80 backdrop-blur-md z-[1000] hidden flex items-center justify-center p-4">
        <div
            class="bg-[#1e3c72] w-full max-w-5xl rounded-3xl overflow-hidden shadow-2xl border border-white/20 flex flex-col max-h-[90vh]">
            <div class="p-6 bg-gradient-to-r from-[#1e3c72] to-[#006847] flex justify-between items-center">
                <div>
                    <h2 class="text-2xl font-black text-[#F6C453] uppercase tracking-tighter">Panel de Gesti√≥n SIG</h2>
                    <p class="text-xs text-white/60">Administra todos los puntos personalizados en la base de datos</p>
                </div>
                <button onclick="closeAdminTable()" class="text-white/60 hover:text-white text-3xl">‚úï</button>
            </div>

            <div class="p-4 bg-white/5 border-b border-white/10 flex gap-4 items-center">
                <div class="relative flex-1">
                    <i class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-white/40"></i>
                    <input type="text" id="admin-search" placeholder="Filtrar por nombre, categor√≠a o descripci√≥n..."
                        class="w-full bg-white/10 border border-white/20 rounded-xl pl-10 pr-4 py-2 text-white outline-none focus:ring-2 focus:ring-[#F6C453]"
                        oninput="filterAdminTable()">
                </div>
                <div class="text-xs text-white/60">
                    Mostrando <span id="admin-count" class="text-[#F6C453] font-bold">0</span> puntos
                </div>
            </div>

            <div class="flex-1 overflow-auto">
                <table class="w-full text-left text-sm">
                    <thead class="bg-black/20 sticky top-0 z-10">
                        <tr>
                            <th class="p-4 font-bold text-[#F6C453] uppercase text-[10px]">ID</th>
                            <th class="p-4 font-bold text-[#F6C453] uppercase text-[10px]">Punto</th>
                            <th class="p-4 font-bold text-[#F6C453] uppercase text-[10px]">Categor√≠a</th>
                            <th class="p-4 font-bold text-[#F6C453] uppercase text-[10px]">Ubicaci√≥n</th>
                            <th class="p-4 font-bold text-[#F6C453] uppercase text-[10px]">Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="admin-table-body" class="divide-y divide-white/5">
                        <!-- Se llena din√°micamente -->
                    </tbody>
                </table>
            </div>

            <div class="p-4 bg-black/20 text-center">
                <button onclick="closeAdminTable()"
                    class="px-8 py-2 bg-[#F6C453] text-[#1e3c72] font-bold rounded-xl hover:bg-white transition-all">
                    CERRAR PANEL
                </button>
            </div>
        </div>
    </div>

    <footer class="w-full text-center text-xs text-white/70 py-6 bg-black/20 mt-8 backdrop-blur-sm">
        <div class="max-w-6xl mx-auto px-4">
            <!-- Universidad -->
            <p class="text-sm">
                <strong class="text-white">¬© 2026 Universidad Veracruzana</strong> | Dise√±o y Desarrollo Web:
                <strong>Juan Daniel Viveros Viveros</strong>
            </p>
        </div>
    </footer>

</body>

</html>